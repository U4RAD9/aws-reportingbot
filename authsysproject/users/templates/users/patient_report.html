<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Report</title>
    {% load static %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* Global Styles */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }
        
        /* Form Styles */
        .input {
            border: none;
            border-bottom: 2px solid #3366cc;
            outline: none;
            font-size: 16px;
            width: 200px;
            padding: 5px;
            margin-bottom: 10px;
        }
        
        .input-container {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }
        
        .gender-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .gender-group label {
            margin-right: 10px;
        }
        
        /* Content Area Styles */
        .content {
            padding: 20px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 0 10px rgb(222, 248, 254);
        }
        
        /* Modal Header Styles */
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            background-color: #f9f9f9;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 5px;
        }
        
        .btn-primary {
            background-color: #3366cc;
            color: white;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        
        /* Form Layout */
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        /* Table Styles */
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .table td, .table th {
            border: 1px solid #9c7373;
            height:40px;
            padding: 12px;
            text-align: center;
            vertical-align: middle;
        }
        
        .table th {
            background-color: #f2f2f2;
        }
        
        /* Observation Section */
        .observation {
            margin-top: 20px;
            margin-left: 5px;
        }
        li{
            font-size: 24px;
        }
        
        /* Doctor Signature Section */
        .doctor-signature {
            display: flex;
            justify-content: space-between;
            margin-top: 200px;
            width: 100%;
        }
        
        .doctor {
            text-align: center;
            margin: 10px;
        }
        
        .doctor img {
            max-width: 400px;
            height: 100px;
            margin-bottom: 1px;
        }
        
        .doctor p {
            margin: 2px 0;
        }
        
        .signature {
            height: 50px;
            margin-bottom: 5px;
        }
        
        /* Checkbox Fieldset */
        fieldset {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        h2 {
            text-decoration: underline;
        }
        
        fieldset label {
            display: block;
            margin-bottom: 8px;
        }
        
        /* Image Styling */
        img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 10px 0;
            border: 1px solid white;
        }
        
        /* Report Container */
        .report-container {
            margin-top: 20px;
            padding: 10px;
            border: 2px solid white;
            background-color: white;
        }
        
        /* Final Report Container */
        .final-report {
            margin-top: 20px;
            padding: 20px;
            border: 2px solid white;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        /* Toggle visibility */
        .hidden {
            display: none;
        }

        .a4-size {
            width: 100%;
            max-width: 794px;
            height: auto;
            background: white;
            border: 1px solid white;
            margin: auto;
          }
          .border-container {
            border: 2px solid black;
            padding: 10px;
            display: inline-block;
        }  
        
        /* Print styles */
        @media print {
            .modal-header, fieldset, .input-container, #ecgFindings, 
            #report-container, .btn, #viewSelect, #actionSelect {
                display: none !important;
            }
            
            .final-report {
                display: block !important;
                margin: 0;
                padding: 0;
                border: none;
                box-shadow: none;
            }
            
            body, .content, .final-report {
                background: white;
                margin: 0;
                padding: 0;
            }
        }

        .loader {
          position: absolute;
          left: 50%;
          top: 50%;
          z-index: 1;
          width: 70px;
          height: 70px;
          margin: -25px 0 0 -25px;
          border: 10px solid transparent;
          border-radius: 50%;
          border-top-color: #3498db;
          -webkit-animation: spin 2s linear infinite;
          animation: spin 2s linear infinite;
          display: none;
        }

        #notification {
          position: absolute;
          left: 50%;
          top: 50%;
          z-index: 2;
          background-color: #3498db;
          margin: -25px 0 0 -25px;
          border: 2px solid #2980b9;
          border-radius: 5px;
          box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
          display: none;
          color: #ecf0f1;
          padding: 25px;
          text-align: center;
          font-family: 'Arial', sans-serif;
        }
        
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.4/jspdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
    <div class="content">
        <div class="modal-header">
            <div><h2>ECG Reporting</h2></div>
            <div>
                <button type="button" class="btn btn-secondary" id="backButton">Back</button>
                <button type="button" class="btn btn-primary" id="doneButton">Done</button>
                <button type="button" class="btn btn-danger" id="rejectButton">Reject</button>
            </div>    
        </div>
        
        <div class="form-row">
            <div class="input-container">
                <label for="campPatientName">Name:</label>
                <input class="input" type="text" id="campPatientName">
            </div>
            <div class="input-container">
                <label for="campPatientId">Patient ID:</label>
                <input class="input" type="text" id="campPatientId">
            </div>
            <div class="input-container">
                <label for="campAge">Age:</label>
                <input class="input" type="text" id="campAge">
            </div>
        </div>
        
        <div class="form-row">
            <div class="input-container">
                <label for="campTestDate">Test Date:</label>
                <input type="date" id="campTestDate" class="input">
            </div>
            <div class="input-container">
                <label for="campReportDate">Report Date:</label>
                <input type="date" id="campReportDate" class="input">
            </div>
            <div class="input-container">
                <label for="campHeartRate">Heart Rate:</label>
                <input class="input" type="text" id="campHeartRate">
            </div>
        </div>
        
        <div class="form-row">
            <div class="input-container">
                <div class="gender-group">
                    <label>Gender:</label>
                    <label><input type="radio" name="gender" value="male" checked> Male</label>
                    <label><input type="radio" name="gender" value="female"> Female</label>
                    <label><input type="radio" name="gender" value="others"> Others</label>
                </div>
            </div>
        </div>
        
        <fieldset id="ecgFindings">
            <legend>ECG Findings</legend>
            <label><input type="radio" id="normalECG" name="ecgFindings" value="normalECG"> Normal ECG</label>
            <label><input type="radio" id="sinusRhythmRBBB" name="ecgFindings" value="sinusRhythmRBBB"> Sinus rhythm with incomplete RBBB</label>
            <label><input type="radio" id="sinusTachycardiaRBBB" name="ecgFindings" value="sinusTachycardiaRBBB"> Sinus Tachycardia with incomplete RBBB</label>
            <label><input type="radio" id="sinusBradycardiaRBBB" name="ecgFindings" value="sinusBradycardiaRBBB"> Sinus Bradycardia with incomplete RBBB</label>
            <label><input type="radio" id="sinusBradycardia" name="ecgFindings" value="sinusBradycardia"> Sinus Bradycardia</label>
            <label><input type="radio" id="sinusTachycardia" name="ecgFindings" value="sinusTachycardia"> Sinus Tachycardia</label>
            <label><input type="radio" id="tInversion" name="ecgFindings"> Normal sinus rhythm with t inversion in lead III</label>
        </fieldset>
        
        <div class="input-container">
            <label for="finding">Additional Findings:</label>
            <input type="text" id="finding" class="input">
        </div>
        
        <img id="ecgImage" src="" alt="ECG Graph">
        
        <!-- Generated Report Preview -->
        <div id="report-container" class="report-container">
            <!-- Report will be generated here -->
        </div>
        
        <div class="loader"></div>
        <div id="notification">
          <p id="notification-text"></p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.4/jspdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        // Initialize form data object
        let formData = {
            normalECG: false,
            sinusRhythmRBBB: false,
            sinusTachycardiaRBBB: false,
            sinusBradycardiaRBBB: false,
            sinusBradycardia: false,
            sinusTachycardia: false,
            tInversion: false,
            additionalFindings: ''
        };
        
        // Flag to track if report is finalized
        let isReportFinalized = true;
        
        // Get patient data from session storage
        function getPatientData() {
            const patientData = sessionStorage.getItem('currentPatient');
            return patientData ? JSON.parse(patientData) : null;
        }
        
        // Update form with patient data
        function updateFormWithPatientData() {
            const data = getPatientData();
            if (!data) return;
            
            // Update form inputs
            document.getElementById('campPatientName').value = data.patientName;
            document.getElementById('campPatientId').value = data.patientId;
            document.getElementById('campAge').value = data.age;
            document.getElementById('campHeartRate').value = data.heartRate;
            
            // Set test and report dates
            if (data.testDate) {
                document.getElementById('campTestDate').value = formatDateForInput(data.testDate);
            }
            
            if (data.reportDate) {
                document.getElementById('campReportDate').value = formatDateForInput(data.reportDate);
            }
            
            // Set gender radio buttons
            if (data.gender) {
                const genderRadio = document.querySelector(`input[name="gender"][value="${data.gender.toLowerCase()}"]`);
                if (genderRadio) {
                    genderRadio.checked = true;
                }
            }
            
            // Set ECG image
            const base64Image = sessionStorage.getItem("base64_" + data.patientId);
            if (base64Image) {
                document.getElementById('ecgImage').src = base64Image;
            }
            
            // Generate initial report
            generateReport();
        }
        
        // Format date strings for HTML date inputs (YYYY-MM-DD)
        function formatDateForInput(dateString) {
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
                return dateString;
            }
            
            const date = new Date(dateString);
            if (isNaN(date.getTime())) {
                return '';
            }
            
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // Generate and update the report
        function generateReport() {
            // Get current form values
            const name = document.getElementById('campPatientName').value;
            const patientId = document.getElementById('campPatientId').value;
            const age = document.getElementById('campAge').value;
            const gender = document.querySelector('input[name="gender"]:checked')?.value || 'Male';
            const testDate = document.getElementById('campTestDate').value;
            const reportDate = document.getElementById('campReportDate').value;
            const heartRate = document.getElementById('campHeartRate').value;
            
            // Get checkbox values
            formData.normalECG = document.getElementById('normalECG').checked;
            formData.sinusRhythmRBBB = document.getElementById('sinusRhythmRBBB').checked;
            formData.sinusTachycardiaRBBB = document.getElementById('sinusTachycardiaRBBB').checked;
            formData.sinusBradycardiaRBBB = document.getElementById('sinusBradycardiaRBBB').checked;
            formData.sinusBradycardia = document.getElementById('sinusBradycardia').checked;
            formData.sinusTachycardia = document.getElementById('sinusTachycardia').checked;
            formData.tInversion = document.getElementById('tInversion').checked;
            formData.additionalFindings = document.getElementById('finding').value;
            
            // Format dates for display
            const displayTestDate = formatDateForDisplay(testDate);
            const displayReportDate = formatDateForDisplay(reportDate);
            
            let reportHTML = `
                <div id="editable-report" class="a4-size" contenteditable="true">
                    <div id="show">
                        <table id="table" class="table">
                            <tr>
                                <td><strong>Name:</strong> <strong>${name}</strong></td>
                                <td><strong>Patient ID:</strong> <strong>${patientId}</strong></td>
                                <td><strong>Age:</strong> <strong>${age}</strong></td>
                            </tr>
                            <tr>
                                <td><strong>Gender:</strong> <strong>${gender}</strong></td>
                                <td><strong>Test Date:</strong> <strong>${displayTestDate}</strong></td>
                                <td><strong>Report Date:</strong> <strong>${displayReportDate}</strong></td>
                            </tr>
                        </table>
                        <div class="observation">
                            <h2><u><strong>ECG</strong></u></h2>
                            <h2><u><strong>Observation:</u></strong></h2>
                            <ul>
                                <li><strong>Heart rate is ${heartRate} BPM.</strong></li><br>
            `;
            
            // Add findings with bold formatting
            if (formData.normalECG) {
                reportHTML += `<li><strong>Normal Sinus Rhythm.</strong></li><br><li><strong>No significant ST-T changes seen.</strong></li>`;
            } else {
                if (formData.sinusRhythmRBBB) {
                    reportHTML += `<li><strong>Sinus rhythm with incomplete RBBB.</strong></li><br><li><strong>No significant ST-T changes seen.</strong></li>`;
                }
                if (formData.sinusTachycardiaRBBB) {
                    reportHTML += `<li><strong>Sinus Tachycardia with incomplete RBBB.</strong></li><br><li><strong>No significant ST-T changes seen.</strong></li>`;
                }
                if (formData.sinusBradycardiaRBBB) {
                    reportHTML += `<li><strong>Sinus Bradycardia with incomplete RBBB.</strong></li><br><li><strong>No significant ST-T changes seen.</strong></li>`;
                }
                if (formData.sinusBradycardia) {
                    reportHTML += `<li><strong>Sinus Bradycardia.</strong></li><br><li><strong>No significant ST-T changes seen.</strong></li>`;
                }
                if (formData.sinusTachycardia) {
                    reportHTML += `<li><strong>Sinus Tachycardia.</strong></li><br><li><strong>No significant ST-T changes seen.</strong></li>`;
                }
                if(formData.tInversion) {
                    reportHTML += `<li><strong>Normal sinus rhythm with t inversion in lead III.</strong></li>`;
                }
            }
            
            // Add additional findings in bold
            if (formData.additionalFindings) {
                reportHTML += `<li><strong>${formData.additionalFindings}</strong></li>`;
            }
            
            // Add default finding if nothing is selected
            if (!formData.normalECG &&
                !formData.sinusRhythmRBBB &&
                !formData.sinusTachycardiaRBBB &&
                !formData.sinusBradycardiaRBBB &&
                !formData.sinusBradycardia &&
                !formData.sinusTachycardia &&
                !formData.additionalFindings &&
                !formData.tInversion) {
                reportHTML += `<li><strong>Normal Sinus Rhythm.</strong></li><br>`;
                reportHTML += `<li><strong>No significant ST-T changes seen.</strong></li>`;
            }
            
            reportHTML += `
                            </ul>
                        </div>
                        <div class="doctor-signature">
                            <div class="doctor">
                                <img src="{% static 'image/Signature1.png' %}" alt="Signature 1">
                                <p><strong>Dr. Arvind Dass</strong></p>
                                <p><strong>Principal Director</strong></p>
                                <p><strong>DM Cardiology</strong></p>
                            </div>
                            <div></div>
                            <div class="doctor">
                                <img src="{% static 'image/Signature2.png' %}" alt="Signature 2">
                                <p><strong>Dr. Nalin Singhal</strong></p>
                                <p><strong>Consultant</strong></p>
                                <p><strong>Non Invasive Cardiology</strong></p>
                            </div>  
                        </div>
                    </div>
            `;
            
            // Display ECG image
            if (document.getElementById('ecgImage').src) {
                reportHTML += `
                      <div id="ecgImage" class="ecg-image-container">
                          <img src="${document.getElementById('ecgImage').src}" alt="ECG Graph">
                      </div>
                    </div>  
                `;
            }
            
            // Update report container
            document.getElementById('report-container').innerHTML = reportHTML;
            
            // If report is finalized, update final report as well
            if (isReportFinalized) {
                document.getElementById('finalReport').innerHTML = reportHTML;
            }
        }
        
        function formatDateForDisplay(dateString) {
            if (!dateString) return '';
            
            const date = new Date(dateString);
            if (isNaN(date.getTime())) {
                return dateString;
            }
        
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
        
            return `${day}-${month}-${year}`;
        }
        
        // Finalize report function - called when Done button is clicked
        function finalizeReport() {
            isReportFinalized = true;
            
            // Copy the current report to the final report container
            const reportHTML = document.getElementById('report-container').innerHTML;
            const finalReportContainer = document.getElementById('finalReport');
            
            finalReportContainer.innerHTML = reportHTML;
            finalReportContainer.classList.remove('hidden');
        }

        // Showing the notification on the browser.
        function showNotification(message) {
            const notification = document.getElementById("notification");
            const notificationText = document.getElementById("notification-text");
      
            if (notification && notificationText) {
                notificationText.innerText = message;
                notification.style.display = "block";
      
                setTimeout(() => {
                    notification.style.display = "none";
                }, 1500);
            }
        }

        // Get CSRF token
        function getCSRFToken() {
            const cookieValue = document.cookie
                .split('; ')
                .find(row => row.startsWith('csrftoken='))
                ?.split('=')[1];
            return cookieValue || '';
        }

        // Show loader
        function showLoader() {
            console.log("Showing loader");
            const loader = document.querySelector(".loader");
            if (loader) {
                loader.style.display = "block";
            }
        }
      
        // Hide loader
        function hideLoader() {
            console.log("Hiding loader");
            const loader = document.querySelector(".loader");
            if (loader) {
                loader.style.display = "none";
            }
        }
        
        // Notify parent window when reporting is complete
        function notifyParentReportingComplete() {
            if (window.parent !== window) {
                window.parent.postMessage({ type: 'REPORTING_COMPLETE' }, '*');
            }
        }
        
        async function handleReject(event) {
            if (event) event.preventDefault();
        
            const patientData = getPatientData();
            if (!patientData || !patientData.patientId) {
                console.error("Patient ID not found.");
                return;
            }
        
            console.log("Rejecting patient with ID:", patientData.patientId);
        
            const csrftoken = getCSRFToken();
            if (!csrftoken) {
                console.error("CSRF token not found.");
                return;
            }
        
            try {
                showLoader();
                const response = await fetch(`/api/reject_patient_status/${patientData.patientId}/`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrftoken,
                    },
                    body: JSON.stringify({ status: true }),
                });
        
                if (response.ok) {
                    console.log("Patient report rejected successfully.");
                    notifyParentReportingComplete();
                    // Close the modal after a short delay
                    setTimeout(() => {
                        window.parent.document.getElementById('reportingModal').style.display = 'none';
                        window.parent.document.querySelector('.modal-backdrop').remove();
                    }, 1000);
                } else {
                    console.error("Failed to update patient status.");
                    hideLoader();
                }
            } catch (error) {
                console.error("Error:", error);
                hideLoader();
            }
        }
        
        async function handleDone() {
            const patientData = getPatientData();
            if (!patientData || !patientData.patientId) {
                console.error("Patient ID not found.");
                return;
            }
        
            const csrftoken = getCSRFToken();
            if (!csrftoken) {
                console.error("CSRF token not found.");
                return;
            }
        
            try {
                showLoader();
                const response = await fetch(`/api/update_patient_done_status/${patientData.patientId}/`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrftoken,
                    },
                    body: JSON.stringify({ isDone: true }),
                });
                
                if (response.ok) {
                    console.log("Patient report marked as done.");
                    notifyParentReportingComplete();
                    // Close the modal after a short delay
                    setTimeout(() => {
                        window.parent.document.getElementById('reportingModal').style.display = 'none';
                        window.parent.document.querySelector('.modal-backdrop').remove();
                    }, 1000);
                } else {
                    console.error("Failed to update isDone status");
                    hideLoader();
                }
            } catch (error) {
                console.error("Error:", error);
                hideLoader();
            }
        }
        
        // Initialize event listeners
        function initializeEventListeners() {
            // Form inputs
            document.querySelectorAll('.input, #ecgFindings input').forEach(input => {
                input.addEventListener('change', generateReport);
                input.addEventListener('input', generateReport);
            });
            
            // Button handlers
            document.getElementById('doneButton').addEventListener('click', function() {
                finalizeReport();
                handleDone().catch(console.error);
            });
            
            document.getElementById('rejectButton').addEventListener('click', function() {
                handleReject().catch(console.error);
            });
            
            document.getElementById('backButton').addEventListener('click', function() {
                // Close the modal
                window.parent.document.getElementById('reportingModal').style.display = 'none';
                window.parent.document.querySelector('.modal-backdrop').remove();
            });
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            updateFormWithPatientData();
            initializeEventListeners();
        });
    </script>
</body>
</html>