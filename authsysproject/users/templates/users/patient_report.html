<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Report</title>
    {% load static %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* Global Styles */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }
        
        /* Navigation Bar Styles */
        .navbar {
            background-color: white;
            padding: 15px 20px;
            display: flex; 
            justify-content: space-between;
            align-items: center; 
            border-bottom: 2px solid #ddd; 
            position: fixed; 
            top: 0;
            left: 0;
            width: 100%;
            box-sizing: border-box;
            z-index: 1000;
        }
        
        .nav-left {
            display: flex;
            gap: 15px;
        }
        
        .nav-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        /* Form Styles */
        .input {
            border: none;
            border-bottom: 2px solid #3366cc;
            outline: none;
            font-size: 16px;
            width: 200px;
            padding: 5px;
            margin-bottom: 10px;
        }
        
        .input-container {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }
        
        .gender-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .gender-group label {
            margin-right: 10px;
        }
        
        /* Content Area Styles */
        .content {
            padding: 20px;
            background: white;
            margin: 80px 20px 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgb(222, 248, 254);
        }
        
        /* Modal Header Styles */
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            background-color: #f9f9f9;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 5px;
        }
        
        .btn-primary {
            background-color: #3366cc;
            color: white;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        
        /* Form Layout */
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        /* Table Styles */
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .table td, .table th {
            border: 1px solid #9c7373;
            height:40px;
            padding: 12px;
            text-align: center; /* Centers text */
            vertical-align: middle; /* Centers content vertically */
        }
        
        .table th {
            background-color: #f2f2f2;
        }
        
        /* Observation Section */
        .observation {
            margin-top: 20px;
            margin-left: 5px;
        }
        li{
            font-size: 24px;
        }
        
        /* Doctor Signature Section */
        .doctor-signature {
            display: flex;
            justify-content: space-between;
            margin-top: 200px;
            width: 100%;
        }
        
        .doctor {
            text-align: center;
            margin: 10px; /* Reduced margin */
        }
        
        .doctor img {
            max-width: 400px; /* Ensures image is responsive */
            height: 100px;
            margin-bottom: 1px; /* Adjust space below the image */
        }
        
        .doctor p {
            margin: 2px 0; /* Minimize gaps between paragraphs */
        }
        
        .signature {
            height: 50px;
            margin-bottom: 5px;
        }
        
        /* Logout Button Styling */
        .login {
            background-color: #dc3545;
            padding: 5px 10px;
            border-radius: 4px;
        }
        
        .login a {
            color: white;
            text-decoration: none;
        }
        
        /* Checkbox Fieldset */
        fieldset {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        h2 {
            text-decoration: underline;
        }
        
        fieldset label {
            display: block;
            margin-bottom: 8px;
        }
        
        /* Image Styling */
        img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 10px 0;
            border: 1px solid white;
        }
        
        /* Report Container */
        .report-container {
            margin-top: 20px;
            padding: 10px;
            border: 2px solid white;
            background-color: white;
        }
        
        /* Final Report Container */
        .final-report {
            margin-top: 20px;
            padding: 20px;
            border: 2px solid white;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        /* Toggle visibility */
        .hidden {
            display: none;
        }

        .a4-size {
            width: 100%;
            max-width: 794px; /* A4 width in pixels at 96 DPI */
            height: auto; /* A4 height in pixels at 96 DPI */
            background: white;
            border: 1px solid white;
            margin: auto;
          }
          .border-container {
            border: 2px solid black; /* Border color */
            padding: 10px;
            display: inline-block;
        }  
          
        
        /* Print styles */
        @media print {
            .navbar, .modal-header, fieldset, .input-container, #ecgFindings, 
            #report-container, .btn, #viewSelect, #actionSelect, .login {
                display: none !important;
            }
            
            .final-report {
                display: block !important;
                margin: 0;
                padding: 0;
                border: none;
                box-shadow: none;
            }
            
            body, .content, .final-report {
                background: white;
                margin: 0;
                padding: 0;
            }
        }

        .loader {
          position: absolute;
          left: 50%;
          top: 50%;
          z-index: 1;
          width: 70px;
          height: 70px;
          margin: -25px 0 0 -25px;
          border: 10px solid transparent;
          border-radius: 50%;
          border-top-color: #3498db;
          -webkit-animation: spin 2s linear infinite;
          animation: spin 2s linear infinite;
          display: none; /* Initially hide the loader */
        }

        #notification {
          position: absolute;
          left: 50%;
          top: 50%;
          z-index: 2;
          background-color: #3498db;
          margin: -25px 0 0 -25px;
          border: 2px solid #2980b9;
          border-radius: 5px;
          box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
          display: none; /* Initially hide the loader */
          color: #ecf0f1;
          padding: 25px;
          text-align: center;
          font-family: 'Arial', sans-serif;
        }  
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.4/jspdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-left">
            <select id="viewSelect">
                <option value="reporting-bot">Reporting Bot</option>
                <option value="camp-ecg">CAMP ECG</option>
            </select>
            <select id="actionSelect" onchange="handleAction(this.value)" placeholder="Export">
                <option value="export" >Export</option>
                <option value="get-pdf">Get PDF</option>
                <option value="upload-pdf">Upload ECG PDF</option>
            </select>
        </div>
        <div class="nav-right">
            <div class="user-name">Welcome </div>
            <div class="login"><a href="/logout" class="report-here">Logout</a></div>
        </div>
    </nav>
    
    <!-- Reporting Bot View -->
    <div id="reporting-bot" class="content">
        <div class="loader"></div>
        <div id="notification">
          <p id="notification-text"></p>
        </div>
        <div><h2>Patient Report</h2>
            
            <img id="baseImage" alt="ECG Report Image" />
        </div>
        
        <!-- Final Report (initially hidden) -->
        <div id="finalReport" class="final-report hidden">
            <!-- Will be populated when Done is clicked -->
        </div>
    </div>

    <!-- Camp ECG View -->
    <div id="camp-ecg" class="content" style="display:none;">
        <div class="modal-header">
            <div><h2>Camp (ECG)</h2></div>
            <div>
                <button type="button" class="btn btn-secondary" id="backButton">Back</button>
                <button type="button" class="btn btn-primary" id="doneButton">Done</button>
                <button type="button" class="btn btn-danger" id="rejectButton">Reject</button>
            </div>    
        </div>
        
        <div class="form-row">
            <div class="input-container">
                <label for="campPatientName">Name:</label>
                <input class="input" type="text" id="campPatientName">
            </div>
            <div class="input-container">
                <label for="campPatientId">Patient ID:</label>
                <input class="input" type="text" id="campPatientId">
            </div>
            <div class="input-container">
                <label for="campAge">Age:</label>
                <input class="input" type="text" id="campAge">
            </div>
        </div>
        
        <div class="form-row">
            <div class="input-container">
                <label for="campTestDate">Test Date:</label>
                <input type="date" id="campTestDate" value="{{ patient.TestDate }}" class="input">
            </div>
            <div class="input-container">
                <label for="campReportDate">Report Date:</label>
                <input type="date" id="campReportDate" value="{{ patient.ReportDate }}" class="input">
            </div>
            <div class="input-container">
                <label for="campHeartRate">Heart Rate:</label>
                <input class="input" type="text" id="campHeartRate">
            </div>
        </div>
        
        <div class="form-row">
            <div class="input-container">
                <div class="gender-group">
                    <label>Gender:</label>
                    <label><input type="radio" name="gender" value="male" checked> Male</label>
                    <label><input type="radio" name="gender" value="female"> Female</label>
                    <label><input type="radio" name="gender" value="others"> Others</label>
                </div>
            </div>
        </div>
{% comment %}         
        <fieldset id="ecgFindings">
            <legend>ECG Findings</legend>
            <label><input type="checkbox" id="normalECG" name="ecgFindings"> Normal ECG</label>
            <label><input type="checkbox" id="sinusRhythmRBBB" name="ecgFindings"> Sinus rhythm with incomplete RBBB</label>
            <label><input type="checkbox" id="sinusTachycardiaRBBB" name="ecgFindings"> Sinus Tachycardia with incomplete RBBB</label>
            <label><input type="checkbox" id="sinusBradycardiaRBBB" name="ecgFindings"> Sinus Bradycardia with incomplete RBBB</label>
            <label><input type="checkbox" id="sinusBradycardia" name="ecgFindings"> Sinus Bradycardia</label>
            <label><input type="checkbox" id="sinusTachycardia" name="ecgFindings"> Sinus Tachycardia</label>
            <label><input type="checkbox" id="tInversion" name="ecgFindings"> Normal sinus rhythm with t inversion in lead III</label>
        </fieldset>
         {% endcomment %}
         <fieldset id="ecgFindings">
            <legend>ECG Findings</legend>
            <label><input type="radio" id="normalECG" name="ecgFindings" value="normalECG"> Normal ECG</label>
            <label><input type="radio" id="sinusRhythmRBBB" name="ecgFindings" value="sinusRhythmRBBB"> Sinus rhythm with incomplete RBBB</label>
            <label><input type="radio" id="sinusTachycardiaRBBB" name="ecgFindings" value="sinusTachycardiaRBBB"> Sinus Tachycardia with incomplete RBBB</label>
            <label><input type="radio" id="sinusBradycardiaRBBB" name="ecgFindings" value="sinusBradycardiaRBBB"> Sinus Bradycardia with incomplete RBBB</label>
            <label><input type="radio" id="sinusBradycardia" name="ecgFindings" value="sinusBradycardia"> Sinus Bradycardia</label>
            <label><input type="radio" id="sinusTachycardia" name="ecgFindings" value="sinusTachycardia"> Sinus Tachycardia</label>
            <label><input type="radio" id="tInversion" name="ecgFindings"> Normal sinus rhythm with t inversion in lead III</label>
        </fieldset>
        
        
        <div class="input-container">
            <label for="finding">Additional Findings:</label>
            <input type="text" id="finding" class="input">
        </div>
        
        <img id="ecgImage" src="" alt="ECG Graph">
        
        <!-- Generated Report Preview -->
        <div id="report-container" class="report-container">
            <!-- Report will be generated here -->
        </div>
    </div>

    <!-- Add a hidden div to store patient data from Django context -->
    <div id="patient-data" 
        data-patientid="{{ patient.PatientId }}"
        data-patientname="{{ patient.PatientName }}"
        data-age="{{ patient.age }}"
        data-gender="{{ patient.gender }}"
        data-heartrate="{{ patient.HeartRate }}"
        data-printerval="{{ patient.PRInterval }}"
        data-testdate="{{ patient.TestDate }}"
        data-reportdate="{{ patient.ReportDate }}"
        data-image="{{ patient.image }}"
        data-location="{{ patient.location }}">
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.4/jspdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>        
        document.addEventListener("DOMContentLoaded", function () {
            console.log("🚀 DOM fully loaded and parsed.");
            init();
        });
        
        /* ------------------ Patient Data Helpers ------------------ */
        function getPatientData() {
            const sessionData = sessionStorage.getItem("patient_data");
            if (sessionData) {
                return JSON.parse(sessionData);
            }
        
            const div = document.getElementById("patient-data");
            if (div) {
                const data = {
                    patientId: div.dataset.patientid,
                    patientName: div.dataset.patientname,
                    age: div.dataset.age,
                    gender: div.dataset.gender,
                    heartRate: div.dataset.heartrate,
                    prInterval: div.dataset.printerval,
                    testDate: div.dataset.testdate,
                    reportDate: div.dataset.reportdate,
                    reportImage: div.dataset.image, // ✅ aligned key
                    location: div.dataset.location,
                };
                sessionStorage.setItem("patient_data", JSON.stringify(data));
                return data;
            }
        
            return getQueryParams(); // fallback
        }
        
        function getQueryParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                patientId: params.get("data-patientid"),
                patientName: params.get("data-patientname"),
                age: params.get("data-age"),
                gender: params.get("data-gender"),
                heartRate: params.get("data-heartrate"),
                prInterval: params.get("data-printerval"),
                testDate: params.get("data-testdate"),
                reportDate: params.get("data-reportdate"),
                reportImage: params.get("data-reportimage"),
                location: params.get("data-location"),
            };
        }
        
        /* ------------------ UI Helpers ------------------ */
        function populateFormFields(data, mapping) {
            for (const [id, key] of Object.entries(mapping)) {
                const el = document.getElementById(id);
                if (el && data[key]) {
                    if (el.type === "date") {
                        el.value = formatDateForInput(data[key]);
                    } else if (el.type === "radio") {
                        const radio = document.querySelector(
                            `input[name="${el.name}"][value="${data[key].toLowerCase()}"]`
                        );
                        if (radio) radio.checked = true;
                    } else {
                        el.value = data[key];
                    }
                }
            }
        }
        
        function formatDateForInput(dateString) {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return "";
            return date.toISOString().split("T")[0];
        }
        
        function setPatientImage(url) {
            if (!url) {
                console.warn("⚠️ No report image found in patient data.");
                return;
            }
            ["baseImage", "ecgImage", "image"].forEach((id) => {
                const el = document.getElementById(id);
                if (el) el.src = url;
            });
        }
        
        /* ------------------ Main View Switching ------------------ */
        function switchView() {
            const viewSelect = document.getElementById("viewSelect");
            if (!viewSelect) return;
        
            const view = viewSelect.value;
            document.getElementById("reportingBot").style.display =
                view === "reporting-bot" ? "block" : "none";
            document.getElementById("campEcg").style.display =
                view === "camp-ecg" ? "block" : "none";
        
            const patientData = getPatientData();
            if (view === "reporting-bot") {
                updateReportingBotView(patientData);
            } else if (view === "camp-ecg") {
                updateCampEcgView(patientData);
            }
        }
        
        function updateReportingBotView(patientData) {
            if (!patientData) return;
        
            populateFormFields(patientData, {
                patientName: "patientName",
                patientId: "patientId",
                age: "age",
                heartRate: "heartRate",
                testDate: "testDate",
                reportDate: "reportDate",
            });
        
            // gender radio
            if (patientData.gender) {
                const gender = patientData.gender.toLowerCase();
                const radio = document.querySelector(`input[name="gender"][value="${gender}"]`);
                if (radio) radio.checked = true;
            }
        
            setPatientImage(patientData.reportImage);
        }
        
        function updateCampEcgView(patientData) {
            if (!patientData) return;
        
            populateFormFields(patientData, {
                campPatientName: "patientName",
                campPatientId: "patientId",
                campAge: "age",
                campHeartRate: "heartRate",
                campTestDate: "testDate",
                campReportDate: "reportDate",
            });
        
            if (patientData.gender) {
                const gender = patientData.gender.toLowerCase();
                const radio = document.querySelector(
                    `input[name="campGender"][value="${gender}"]`
                );
                if (radio) radio.checked = true;
            }
        
            setPatientImage(patientData.reportImage);
        }
        
        /* ------------------ Report Generation ------------------ */
        function generateReport() {
            const btn = document.getElementById("generateReport");
            if (!btn) return;
        
            btn.addEventListener("click", () => {
                const patientData = getPatientData();
                console.log("📋 Patient data from sessionStorage:", patientData);
        
                const reportContent = document.getElementById("reportContent");
                if (!reportContent) return;
        
                reportContent.innerHTML = `
                    <h2>ECG Report</h2>
                    <p><strong>Patient ID:</strong> ${patientData.patientId || ""}</p>
                    <p><strong>Name:</strong> ${patientData.patientName || ""}</p>
                    <p><strong>Age:</strong> ${patientData.age || ""}</p>
                    <p><strong>Gender:</strong> ${patientData.gender || ""}</p>
                    <p><strong>Heart Rate:</strong> ${patientData.heartRate || ""}</p>
                    <p><strong>PR Interval:</strong> ${patientData.prInterval || ""}</p>
                    <p><strong>Test Date:</strong> ${patientData.testDate || ""}</p>
                    <p><strong>Report Date:</strong> ${patientData.reportDate || ""}</p>
                    <p><strong>Location:</strong> ${patientData.location || ""}</p>
                    ${
                        patientData.reportImage
                            ? `<img src="${patientData.reportImage}" style="max-width:400px;"/>`
                            : "<p>No Image Available</p>"
                    }
                `;
            });
        }
        
        /* ------------------ PDF Export ------------------ */
        async function downloadPDF() {
            const reportContent = document.getElementById("reportContent");
            if (!reportContent) {
                alert("No report content found!");
                return;
            }
        
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
        
            pdf.html(reportContent, {
                callback: function (doc) {
                    const filename = `ECG_Report_${Date.now()}.pdf`;
                    doc.save(filename);
                },
                x: 10,
                y: 10,
            });
        
            // If you need to upload to server, uncomment:
            /*
            const pdfBlob = pdf.output("blob");
            const formData = new FormData();
            formData.append("pdf_file", pdfBlob, filename);
        
            const response = await fetch("/upload-endpoint/", {
                method: "POST",
                body: formData
            });
        
            if (!response.ok) {
                console.error("❌ Failed to upload PDF:", response.statusText);
            }
            */
        }
        
        /* ------------------ Init ------------------ */
        function init() {
            const viewSelect = document.getElementById("viewSelect");
            if (viewSelect) {
                viewSelect.addEventListener("change", switchView);
            }
            switchView(); // set default view
            generateReport();
        }

    </script>
</body>
</html>