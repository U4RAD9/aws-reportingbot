<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Report</title>
    {% load static %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* Global Styles */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }
        
        /* Navigation Bar Styles */
        .navbar {
            background-color: white;
            padding: 15px 20px;
            display: flex; 
            justify-content: space-between;
            align-items: center; 
            border-bottom: 2px solid #ddd; 
            position: fixed; 
            top: 0;
            left: 0;
            width: 100%;
            box-sizing: border-box;
            z-index: 1000;
        }
        
        .nav-left {
            display: flex;
            gap: 15px;
        }
        
        .nav-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        /* Form Styles */
        .input {
            border: none;
            border-bottom: 2px solid #3366cc;
            outline: none;
            font-size: 16px;
            width: 200px;
            padding: 5px;
            margin-bottom: 10px;
        }
        
        .input-container {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }
        
        .gender-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .gender-group label {
            margin-right: 10px;
        }
        
        /* Content Area Styles */
        .content {
            padding: 20px;
            background: white;
            margin: 80px 20px 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgb(222, 248, 254);
        }
        
        /* Modal Header Styles */
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            background-color: #f9f9f9;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 5px;
        }
        
        .btn-primary {
            background-color: #3366cc;
            color: white;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        
        /* Form Layout */
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        /* Table Styles */
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .table td, .table th {
            border: 1px solid #9c7373;
            height:40px;
            padding: 12px;
            text-align: center; /* Centers text */
            vertical-align: middle; /* Centers content vertically */
        }
        
        .table th {
            background-color: #f2f2f2;
        }
        
        /* Observation Section */
        .observation {
            margin-top: 20px;
            margin-left: 5px;
        }
        li{
            font-size: 24px;
        }
        
        /* Doctor Signature Section */
        .doctor-signature {
            display: flex;
            justify-content: space-between;
            margin-top: 200px;
            width: 100%;
        }
        
        .doctor {
            text-align: center;
            margin: 10px; /* Reduced margin */
        }
        
        .doctor img {
            max-width: 400px; /* Ensures image is responsive */
            height: 100px;
            margin-bottom: 1px; /* Adjust space below the image */
        }
        
        .doctor p {
            margin: 2px 0; /* Minimize gaps between paragraphs */
        }
        
        .signature {
            height: 50px;
            margin-bottom: 5px;
        }
        
        /* Logout Button Styling */
        .login {
            background-color: #dc3545;
            padding: 5px 10px;
            border-radius: 4px;
        }
        
        .login a {
            color: white;
            text-decoration: none;
        }
        
        /* Checkbox Fieldset */
        fieldset {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        h2 {
            text-decoration: underline;
        }
        
        fieldset label {
            display: block;
            margin-bottom: 8px;
        }
        
        /* Image Styling */
        img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 10px 0;
            border: 1px solid white;
        }
        
        /* Report Container */
        .report-container {
            margin-top: 20px;
            padding: 10px;
            border: 2px solid white;
            background-color: white;
        }
        
        /* Final Report Container */
        .final-report {
            margin-top: 20px;
            padding: 20px;
            border: 2px solid white;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        /* Toggle visibility */
        .hidden {
            display: none;
        }

        .a4-size {
            width: 100%;
            max-width: 794px; /* A4 width in pixels at 96 DPI */
            height: auto; /* A4 height in pixels at 96 DPI */
            background: white;
            border: 1px solid white;
            margin: auto;
          }
          .border-container {
            border: 2px solid black; /* Border color */
            padding: 10px;
            display: inline-block;
        }  
          
        
        /* Print styles */
        @media print {
            .navbar, .modal-header, fieldset, .input-container, #ecgFindings, 
            #report-container, .btn, #viewSelect, #actionSelect, .login {
                display: none !important;
            }
            
            .final-report {
                display: block !important;
                margin: 0;
                padding: 0;
                border: none;
                box-shadow: none;
            }
            
            body, .content, .final-report {
                background: white;
                margin: 0;
                padding: 0;
            }
        }

        .loader {
          position: absolute;
          left: 50%;
          top: 50%;
          z-index: 1;
          width: 70px;
          height: 70px;
          margin: -25px 0 0 -25px;
          border: 10px solid transparent;
          border-radius: 50%;
          border-top-color: #3498db;
          -webkit-animation: spin 2s linear infinite;
          animation: spin 2s linear infinite;
          display: none; /* Initially hide the loader */
        }

        #notification {
          position: absolute;
          left: 50%;
          top: 50%;
          z-index: 2;
          background-color: #3498db;
          margin: -25px 0 0 -25px;
          border: 2px solid #2980b9;
          border-radius: 5px;
          box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
          display: none; /* Initially hide the loader */
          color: #ecf0f1;
          padding: 25px;
          text-align: center;
          font-family: 'Arial', sans-serif;
        }  
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.4/jspdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-left">
            <select id="viewSelect">
                <option value="reporting-bot">Reporting Bot</option>
                <option value="camp-ecg">CAMP ECG</option>
            </select>
            <select id="actionSelect" onchange="handleAction(this.value)" placeholder="Export">
                <option value="export" >Export</option>
                <option value="get-pdf">Get PDF</option>
                <option value="upload-pdf">Upload ECG PDF</option>
            </select>
        </div>
        <div class="nav-right">
            <div class="user-name">Welcome </div>
            <div class="login"><a href="/logout" class="report-here">Logout</a></div>
        </div>
    </nav>
    
    <!-- Reporting Bot View -->
    <div id="reporting-bot" class="content">
        <div class="loader"></div>
        <div id="notification">
          <p id="notification-text"></p>
        </div>
        <div><h2>Patient Report</h2>
            
            <img id="baseImage" alt="ECG Report Image" />
        </div>
        
        <!-- Final Report (initially hidden) -->
        <div id="finalReport" class="final-report hidden">
            <!-- Will be populated when Done is clicked -->
        </div>
    </div>

    <!-- Camp ECG View -->
    <div id="camp-ecg" class="content" style="display:none;">
        <div class="modal-header">
            <div><h2>Camp (ECG)</h2></div>
            <div>
                <button type="button" class="btn btn-secondary" id="backButton">Back</button>
                <button type="button" class="btn btn-primary" id="doneButton">Done</button>
                <button type="button" class="btn btn-danger" id="rejectButton">Reject</button>
            </div>    
        </div>
        
        <div class="form-row">
            <div class="input-container">
                <label for="campPatientName">Name:</label>
                <input class="input" type="text" id="campPatientName">
            </div>
            <div class="input-container">
                <label for="campPatientId">Patient ID:</label>
                <input class="input" type="text" id="campPatientId">
            </div>
            <div class="input-container">
                <label for="campAge">Age:</label>
                <input class="input" type="text" id="campAge">
            </div>
        </div>
        
        <div class="form-row">
            <div class="input-container">
                <label for="campTestDate">Test Date:</label>
                <input type="date" id="campTestDate" class="input">
            </div>
            <div class="input-container">
                <label for="campReportDate">Report Date:</label>
                <input type="date" id="campReportDate" class="input">
            </div>
            <div class="input-container">
                <label for="campHeartRate">Heart Rate:</label>
                <input class="input" type="text" id="campHeartRate">
            </div>
        </div>
        
        <div class="form-row">
            <div class="input-container">
                <div class="gender-group">
                    <label>Gender:</label>
                    <label><input type="radio" name="gender" value="male" checked> Male</label>
                    <label><input type="radio" name="gender" value="female"> Female</label>
                    <label><input type="radio" name="gender" value="others"> Others</label>
                </div>
            </div>
        </div>
{% comment %}         
        <fieldset id="ecgFindings">
            <legend>ECG Findings</legend>
            <label><input type="checkbox" id="normalECG" name="ecgFindings"> Normal ECG</label>
            <label><input type="checkbox" id="sinusRhythmRBBB" name="ecgFindings"> Sinus rhythm with incomplete RBBB</label>
            <label><input type="checkbox" id="sinusTachycardiaRBBB" name="ecgFindings"> Sinus Tachycardia with incomplete RBBB</label>
            <label><input type="checkbox" id="sinusBradycardiaRBBB" name="ecgFindings"> Sinus Bradycardia with incomplete RBBB</label>
            <label><input type="checkbox" id="sinusBradycardia" name="ecgFindings"> Sinus Bradycardia</label>
            <label><input type="checkbox" id="sinusTachycardia" name="ecgFindings"> Sinus Tachycardia</label>
            <label><input type="checkbox" id="tInversion" name="ecgFindings"> Normal sinus rhythm with t inversion in lead III</label>
        </fieldset>
         {% endcomment %}
         <fieldset id="ecgFindings">
            <legend>ECG Findings</legend>
            <label><input type="radio" id="normalECG" name="ecgFindings" value="normalECG"> Normal ECG</label>
            <label><input type="radio" id="sinusRhythmRBBB" name="ecgFindings" value="sinusRhythmRBBB"> Sinus rhythm with incomplete RBBB</label>
            <label><input type="radio" id="sinusTachycardiaRBBB" name="ecgFindings" value="sinusTachycardiaRBBB"> Sinus Tachycardia with incomplete RBBB</label>
            <label><input type="radio" id="sinusBradycardiaRBBB" name="ecgFindings" value="sinusBradycardiaRBBB"> Sinus Bradycardia with incomplete RBBB</label>
            <label><input type="radio" id="sinusBradycardia" name="ecgFindings" value="sinusBradycardia"> Sinus Bradycardia</label>
            <label><input type="radio" id="sinusTachycardia" name="ecgFindings" value="sinusTachycardia"> Sinus Tachycardia</label>
            <label><input type="radio" id="tInversion" name="ecgFindings"> Normal sinus rhythm with t inversion in lead III</label>
        </fieldset>
        
        
        <div class="input-container">
            <label for="finding">Additional Findings:</label>
            <input type="text" id="finding" class="input">
        </div>
        
        <img id="ecgImage" src="" alt="ECG Graph">
        
        <!-- Generated Report Preview -->
        <div id="report-container" class="report-container">
            <!-- Report will be generated here -->
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.4/jspdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            console.log("🚀 DOM fully loaded and parsed.");
        
            let urlParams = new URLSearchParams(window.location.search);
            let patientId = urlParams.get("data-patientid");
        
            console.log("🔍 Extracted Patient ID from URL:", patientId);
        
            if (patientId) {
                let base64Image = sessionStorage.getItem("base64_" + patientId);
        
                if (base64Image) {
                    console.log("✅ Base64 Image found in sessionStorage!");
                    document.getElementById("baseImage").src = base64Image;
                } else {
                    console.warn("⚠️ No Base64 image found for Patient ID:", patientId);
                }
            } else {
                console.warn("⚠️ No Patient ID found in URL parameters.");
            }
        });

    </script>
    <script>
        // Get URL parameters
        function getQueryParams() {
            const params = new URLSearchParams(window.location.search);
            
            return {
                patientId: params.get('data-patientid') || '',
                patientName: decodeURIComponent(params.get('data-patientname') || ''),
                age: params.get('data-age') || '',
                gender: params.get('data-gender') || '',
                heartRate: params.get('data-heartrate') || '',
                prInterval: params.get('data-printerval') || '',
                testDate: params.get('data-testdate') || '',
                reportDate: params.get('data-reportdate') || '',
                reportImage: decodeURIComponent(params.get('data-reportimage') || ''),
                location: decodeURIComponent(params.get('data-location') || '')
            };
        }
        
        // Initialize form data object
        let formData = {
            normalECG: false,
            sinusRhythmRBBB: false,
            sinusTachycardiaRBBB: false,
            sinusBradycardiaRBBB: false,
            sinusBradycardia: false,
            sinusTachycardia: false,
            tInversion: false,
            additionalFindings: ''
        };
        
        // Flag to track if report is finalized
        let isReportFinalized = true;
        
        function updateReportingBotView() {
            const data = getQueryParams();
            const patientImage = document.getElementById('baseImage');
        }
        
        // Update Camp ECG View
        function updateCampEcgView() {
            const data = getQueryParams();
            
            // Update camp-ecg form inputs
            document.getElementById('campPatientName').value = data.patientName;
            document.getElementById('campPatientId').value = data.patientId;
            document.getElementById('campAge').value = data.age;
            document.getElementById('campHeartRate').value = data.heartRate;
            
            // Set test and report dates
            if (data.testDate) {
                document.getElementById('campTestDate').value = formatDateForInput(data.testDate);
            }
            
            if (data.reportDate) {
                document.getElementById('campReportDate').value = formatDateForInput(data.reportDate);
            }
            
            // Set gender radio buttons
            if (data.gender) {
                const genderRadio = document.querySelector(`input[name="gender"][value="${data.gender.toLowerCase()}"]`);
                if (genderRadio) {
                    genderRadio.checked = true;
                }
            }
            
            // Set ECG image
            document.getElementById('ecgImage').src = data.reportImage;
            
            // Generate initial report
            generateReport();
        }
        
        
        // Format date strings for HTML date inputs (YYYY-MM-DD)
        function formatDateForInput(dateString) {
            // If dateString is already in YYYY-MM-DD format, return as is
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
                return dateString;
            }
            
            // Try to parse the date
            const date = new Date(dateString);
            if (isNaN(date.getTime())) {
                return ''; // Return empty string if invalid date
            }
            
            // Format as YYYY-MM-DD
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // Generate and update the report
        
        function generateReport() {
            // Get current form values
            const name = document.getElementById('campPatientName').value;
            const patientId = document.getElementById('campPatientId').value;
            const age = document.getElementById('campAge').value;
            const gender = document.querySelector('input[name="gender"]:checked')?.value || 'Male';
            const testDate = document.getElementById('campTestDate').value;
            const reportDate = document.getElementById('campReportDate').value;
            const heartRate = document.getElementById('campHeartRate').value;
            
            // Get checkbox values
            formData.normalECG = document.getElementById('normalECG').checked;
            formData.sinusRhythmRBBB = document.getElementById('sinusRhythmRBBB').checked;
            formData.sinusTachycardiaRBBB = document.getElementById('sinusTachycardiaRBBB').checked;
            formData.sinusBradycardiaRBBB = document.getElementById('sinusBradycardiaRBBB').checked;
            formData.sinusBradycardia = document.getElementById('sinusBradycardia').checked;
            formData.sinusTachycardia = document.getElementById('sinusTachycardia').checked;
            formData.tInversion = document.getElementById('tInversion').checked;
            formData.additionalFindings = document.getElementById('finding').value;
            
            // Format dates for display
            const displayTestDate = formatDateForDisplay(testDate);
            const displayReportDate = formatDateForDisplay(reportDate);
            

            let reportHTML = `
                <div id="editable-report" class="a4-size" contenteditable="true">
                    <div id="show">
                        <table id="table" class="table">
                            <tr>
                                <td><strong>Name:</strong> <strong>${name}</strong></td>
                                <td><strong>Patient ID:</strong> <strong>${patientId}</strong></td>
                                <td><strong>Age:</strong> <strong>${age}</strong></td>
                            </tr>
                            <tr>
                                <td><strong>Gender:</strong> <strong>${gender}</strong></td>
                                <td><strong>Test Date:</strong> <strong>${displayTestDate}</strong></td>
                                <td><strong>Report Date:</strong> <strong>${displayReportDate}</strong></td>
                            </tr>
                        </table>
                        <div class="observation">
                            <h2><u><strong>ECG</strong></u></h2>
                            <h2><u><strong>Observation:</u></strong></h2>
                            <ul>
                                <li><strong>Heart rate is ${heartRate} BPM.</strong></li><br>
            `;
            // Add findings with bold formatting
            if (formData.normalECG) {
                reportHTML += `<li><strong>Normal Sinus Rhythm.</strong></li><br><li><strong>No significant ST-T changes seen.</strong></li>`;
            } else {
                if (formData.sinusRhythmRBBB) {
                    reportHTML += `<li><strong>Sinus rhythm with incomplete RBBB.</strong></li><br><li><strong>No significant ST-T changes seen.</strong></li>`;
                }
                if (formData.sinusTachycardiaRBBB) {
                    reportHTML += `<li><strong>Sinus Tachycardia with incomplete RBBB.</strong></li><br><li><strong>No significant ST-T changes seen.</strong></li>`;
                }
                if (formData.sinusBradycardiaRBBB) {
                    reportHTML += `<li><strong>Sinus Bradycardia with incomplete RBBB.</strong></li><br><li><strong>No significant ST-T changes seen.</strong></li>`;
                }
                if (formData.sinusBradycardia) {
                    reportHTML += `<li><strong>Sinus Bradycardia.</strong></li><br><li><strong>No significant ST-T changes seen.</strong></li>`;
                }
                if (formData.sinusTachycardia) {
                    reportHTML += `<li><strong>Sinus Tachycardia.</strong></li><br><li><strong>No significant ST-T changes seen.</strong></li>`;
                }
                if(formData.tInversion) {
                    reportHTML += `<li><strong>Normal sinus rhythm with t inversion in lead III.</strong></li>`;
                }
            }
            
            // Add additional findings in bold
            if (formData.additionalFindings) {
                reportHTML += `<li><strong>${formData.additionalFindings}</strong></li>`;
            }
            
            // Add default finding if nothing is selected
            if (!formData.normalECG &&
                !formData.sinusRhythmRBBB &&
                !formData.sinusTachycardiaRBBB &&
                !formData.sinusBradycardiaRBBB &&
                !formData.sinusBradycardia &&
                !formData.sinusTachycardia &&
                !formData.additionalFindings &&
                !formData.tInversion) {
                reportHTML += `<li><strong>Normal Sinus Rhythm.</strong></li><br>`;
                reportHTML += `<li><strong>No significant ST-T changes seen.</strong></li>`;
            }
            
            reportHTML += `
                            </ul>
                        </div>
                        <div class="doctor-signature">
                            <div class="doctor">
                                <img src="{% static 'image/Signature1.png' %}" alt="Signature 1">
                                <p><strong>Dr. Arvind Dass</strong></p>
                                <p><strong>Principal Director</strong></p>
                                <p><strong>DM Cardiology</strong></p>
                            </div>
                            <div></div>
                            <div class="doctor">
                                <img src="{% static 'image/Signature2.png' %}" alt="Signature 2">
                                <p><strong>Dr. Nalin Singhal</strong></p>
                                <p><strong>Consultant</strong></p>
                                <p><strong>Non Invasive Cardiology</strong></p>
                            </div>  
                        </div>
                    </div>
            `;
            // Display ECG image
            if (document.getElementById('ecgImage').src) {
                reportHTML += `
                      <div id="ecgImage" class="ecg-image-container">
                          <img src="${document.getElementById('ecgImage').src}" alt="ECG Graph">
                      </div>
                    </div>  
                      
                `;
            }
            
            // Update report container
            document.getElementById('report-container').innerHTML = reportHTML;
            
            // Also update patient info in reporting-bot view
            document.getElementById('patientName').textContent = name;
            document.getElementById('patientId').textContent = patientId;
            document.getElementById('patientAge').textContent = age;
            document.getElementById('patientGender').textContent = gender;
            document.getElementById('patientHeartRate').textContent = heartRate;
            document.getElementById('patientTestDate').textContent = displayTestDate;
            document.getElementById('patientReportDate').textContent = displayReportDate;
            
            // If report is finalized, update final report as well
            if (isReportFinalized) {
                document.getElementById('finalReport').innerHTML = reportHTML;
            }
        }
        
        // Format date for display (e.g., "Jan 21, 2025")
        function formatDateForDisplay(dateString) {
            if (!dateString) return '';
            
            const date = new Date(dateString);
            if (isNaN(date.getTime())) {
                return dateString; // Return original string if invalid date
            }
            
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }
        
        // Finalize report function - called when Done button is clicked
        function finalizeReport() {
            isReportFinalized = true;
            
            // Copy the current report to the final report container
            const reportHTML = document.getElementById('report-container').innerHTML;
            const finalReportContainer = document.getElementById('finalReport');
            //handleDone().catch(console.error);
            
            finalReportContainer.innerHTML = reportHTML;
            finalReportContainer.classList.remove('hidden');
            
            // Show final report in reporting-bot view
            document.getElementById('viewSelect').value = 'reporting-bot';
            document.getElementById('reporting-bot').style.display = 'block';
            document.getElementById('camp-ecg').style.display = 'none';
        }


        // Showing the notification on the browser.
        showNotification = (message) => {
            const notification = document.getElementById("notification");
            const notificationText = document.getElementById("notification-text");
      
            if (notification && notificationText) {
                notificationText.innerText = message;
                notification.style.display = "block";
      
                setTimeout(() => {
                    notification.style.display = "none";
                }, 1500);
            }
        };


        // Add this at the top level of your script
        function getCSRFToken() {
            const cookieValue = document.cookie
                .split('; ')
                .find(row => row.startsWith('csrftoken='))
                ?.split('=')[1];
            return cookieValue || '';
        }

        async function fetchImageAsBase64(imageUrl) {
            try {
                const response = await fetch(imageUrl, { mode: "cors" });
                const blob = await response.blob();
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.readAsDataURL(blob);
                });
            } catch (error) {
                console.error("❌ Error fetching image:", error);
                return null;
            }
        }


        showLoader = () => {
          console.log("Showing loader");
          const loader = document.querySelector(".loader");
          if (loader) {
              loader.style.display = "block";
          }
        };
      
        // This will hide the loader after report generation and doing respective task.
        hideLoader = () => {
          console.log("Hiding loader");
          const loader = document.querySelector(".loader");
          if (loader) {
              loader.style.display = "none";
          }
        };

        
        async function downloadPDF() {
            const element = document.getElementById("show");
            if (!element) {
                console.error("Element with ID 'finalReport' not found.");
                alert("Report not found. Please check if the report is visible.");
                return;
            }


            // Extract parameters from the URL
            const urlParams = new URLSearchParams(window.location.search);
            const patientId = urlParams.get("data-patientid");
            console.log(patientId);
            console.log(typeof(patientId));
            const patientName = urlParams.get("data-patientname");
        
            // Fetch the baseImage from the DOM
            const baseImageElement = document.getElementById("baseImage");
            if (!baseImageElement || !baseImageElement.src) {
                console.error("❌ Base image not found in DOM.");
                alert("Base image is missing.");
                return;
            }
            const base64Image = baseImageElement.src;
            console.log("✅ Using baseImage:", base64Image);
        
            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: "portrait",
                    unit: "px",
                    format: "a4"
                });
        
                const pageWidth = pdf.internal.pageSize.width;
                const pageHeight = pdf.internal.pageSize.height;
        
                // Load the image
                const img = new Image();
                img.src = base64Image;
        
                await new Promise((resolve) => (img.onload = resolve));
        
                // Create a canvas to rotate the image
                const canvas = document.createElement("canvas");
                const ctx = canvas.getContext("2d");
        
                // Swap width and height for rotation
                canvas.width = img.height;
                canvas.height = img.width;
        
                // Rotate the image by 90 degrees
                ctx.translate(canvas.width / 2, canvas.height / 2);
                ctx.rotate(90 * Math.PI / 180);
                ctx.drawImage(img, -img.width / 2, -img.height / 2);
        
                // Convert rotated image to Base64
                const rotatedImage = canvas.toDataURL("image/png");
                
                console.log("✅ Rotated image generated!");
        
                // Ensure the image fits properly within the PDF page
                let newWidth = pageWidth ; // Leave some margin
                let newHeight = (img.height / img.width) * newWidth*1.75;
        
                if (newHeight > pageHeight - 40) {
                    newHeight = pageHeight ;
                    newWidth = (img.width / img.height) * newHeight;
                }
        
                // Center the image
                const xPos = (pageWidth - newWidth) / 2;
                const yPos = (pageHeight - newHeight) / 2;
        
                pdf.addImage(rotatedImage, "PNG", xPos, yPos, newWidth, newHeight);
        
                console.log("✅ Image added to PDF!");
        
                // Generate the second page with the final report
                element.style.display = "block"; // Ensure visibility
                setTimeout(() => {
                    html2canvas(element, { scale: 2, useCORS: true, allowTaint: true 
                    }).then(canvas => {
                            const imgData = canvas.toDataURL("image/jpeg", 0.98);
                            pdf.addPage();

                        //used for copy the text
                        const textContent = element.innerText || element.textContent;
        
                        if (!textContent.trim()) {
                            console.warn("⚠️ No text found in 'show' element.");
                        }
                
                        // Set font to monospaced (prevents structure distortion)
                        pdf.setFont("courier", "normal"); // Use 'courier' for fixed-width font
                        pdf.setFontSize(12);
                
                        const margin = 5;
                        const maxWidth = pageWidth - 1 * margin;
                        const textLines = pdf.splitTextToSize(textContent, maxWidth);
                        pdf.setTextColor(255, 255, 255); // Set text color to white (invisible on white background)
                        pdf.text(textLines, margin, margin + 10);

                        //end of copy text

                        pdf.addImage(imgData, "JPEG", 10, 120, pageWidth - 20, pageHeight - 300);

                        // Generate the filename in the format: patientID_patientName.pdf
                        const fileName = `${patientId.replace(/\s+/g, "_")}_${patientName.replace(/\s+/g, "_")}.pdf`;
    
                        pdf.save(fileName);
                        handleDone().catch(console.error);
                        if (response.ok) {
                            console.log("✅ PDF successfully sent to backend.");
                            showNotification("PDF successfully uploaded!");
                            setTimeout(() => {
                                window.location.href = document.referrer + "?nocache=" + Date.now();
                            }, 2000);
                        } else {
                            console.error("❌ Failed to upload PDF.");
                            showNotification("Error uploading PDF. Please try again.");
                        }
                        console.log("✅ PDF saved successfully!");
                    });
                }, 500);
        
                // img.onerror = function () {
                //     console.error("❌ Failed to load the image.");
                //     alert("Error loading the report image.");
                // };
        
            } catch (error) {
                console.error("❌ Error generating PDF:", error);
                alert("Failed to generate the report. Please try again.");
            }
        }

        
        // Handle action select change
        function handleAction(action) {
            if (action === 'get-pdf') {
                downloadPDF();
            } else if (action === 'export') {
                handleAction();
            } else if (action === 'upload-pdf') {
                uploadEcgPDF();
            }
            
            // Reset select to default
            document.getElementById('actionSelect').value = '';
        }

        // Switch between views
        function switchView() {
            const reportingBot = document.getElementById('reporting-bot');
            const campEcg = document.getElementById('camp-ecg');
            const viewSelect = document.getElementById('viewSelect');
            
            if (viewSelect.value === 'reporting-bot') {
                reportingBot.style.display = 'block';
                campEcg.style.display = 'none';
                updateReportingBotView();
            } else {
                reportingBot.style.display = 'none';
                campEcg.style.display = 'block';
                updateCampEcgView();
            }
        }
        
        // Initialize event listeners
        function initializeEventListeners() {
            // View selector
            document.getElementById('viewSelect').addEventListener('change', switchView);
            
            // Form inputs
            document.querySelectorAll('#camp-ecg input').forEach(input => {
                input.addEventListener('change', generateReport);
                input.addEventListener('input', generateReport);
            });
            
            // ECG Findings checkboxes special handling - sync with form data
            document.querySelectorAll('input[name="ecgFindings"]').forEach(checkbox => {
                checkbox.addEventListener('change', generateReport);
            });
            
            // Button handlers
            document.getElementById('doneButton').addEventListener('click', finalizeReport);
            
            document.getElementById('rejectButton').addEventListener('click', function() {
                handleReject().catch(console.error);
                // Here you would typically handle the rejection logic
            });
            
            document.getElementById('backButton').addEventListener('click', function() {
                document.getElementById('viewSelect').value = 'reporting-bot';
                switchView();
            });
        }

        async function handleReject(event) {
            if (event) event.preventDefault(); // Prevent unintended redirection if event exists
        
            const urlSearchParams = new URLSearchParams(window.location.search);
            const patientId = urlSearchParams.get("data-patientid");
        
            if (!patientId) {
                console.error("Patient ID not found in URL.");
                return;
            }
        
            console.log("Rejecting patient with ID:", patientId);
        
            function getCSRFToken() {
                const match = document.cookie.match(/csrftoken=([\w-]+)/);
                return match ? match[1] : null;
            }
        
            const csrftoken = getCSRFToken();
            if (!csrftoken) {
                console.error("CSRF token not found.");
                return;
            }
        
            try {
                const response = await fetch(`/api/reject_patient_status/${patientId}/`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrftoken,
                    },
                    body: JSON.stringify({ status: true }),
                });
        
                if (response.ok) {
                    console.log("Patient report rejected successfully.");
        
                    // Remove the rejected report from the dashboard
                    const reportElement = document.querySelector(`[data-patientid="${patientId}"]`);
                    if (reportElement) {
                        reportElement.remove();
                    }
        
                    // Delay redirection slightly to ensure the removal is visible
                    setTimeout(() => {
                        window.location.href = "/ecgallocation";
                    }, 500);
                } else {
                    console.error("Failed to update patient status.");
                }
            } catch (error) {
                console.error("Error:", error);
            }
        }
        async function handleDone() {
            // Get the patient ID from URL parameters
            const urlSearchParams = new URLSearchParams(window.location.search);
            const patientId = urlSearchParams.get("data-patientid");
        
            if (!patientId) {
                console.error("Patient ID not found in URL.");
                return;
            }
        
            // Get the CSRF token from cookies
            function getCSRFToken() {
                const match = document.cookie.match(/csrftoken=([\w-]+)/);
                return match ? match[1] : null;
            }
        
            const csrftoken = getCSRFToken();
            if (!csrftoken) {
                console.error("CSRF token not found.");
                return;
            }
        
            try {
                const response = await fetch(`/api/update_patient_done_status/${patientId}/`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrftoken,
                    },
                    body: JSON.stringify({ isDone: true }),
                });
                console.log("Response:", response);
        
                /*if (response.ok) {
                    // Navigate back to refresh data
                    window.location.href = document.referrer + "?nocache=" + Date.now();
                } else {
                    console.error("Failed to update isDone status");
                }*/
            } catch (error) {
                console.error("Error:", error);
            }
        }
        
        
        async function uploadEcgPDF() {
            // Show loader
            function showLoader() {
                console.log("Showing loader");
                const loader = document.querySelector(".loader");
                if (loader) loader.style.display = "block";
            }
        
            // Hide loader
            function hideLoader() {
                console.log("Hiding loader");
                const loader = document.querySelector(".loader");
                if (loader) loader.style.display = "none";
            }
        
            // Extract patient data from URL
            function extractDataFromURL() {
                const urlParams = new URLSearchParams(window.location.search);
                const params = getQueryParams();
                let reportImag = params.reportImage;
                return {
                    patientId: urlParams.get("data-patientid"),
                    patientName: urlParams.get("data-patientname"),
                    testDate: urlParams.get("data-testdate"),
                    reportDate: urlParams.get("data-reportdate"),
                    location: urlParams.get("data-location"),
                    // reportImage: reportImag // Extract image URL
                    //reportImage: decodeURIComponent(urlParams.get("data-reportimage"))
                };
            }
        
            // Show notification message
            function showNotification(message) {
                const notification = document.getElementById("notification");
                const notificationText = document.getElementById("notification-text");
                if (notification && notificationText) {
                    notificationText.innerText = message;
                    notification.style.display = "block";
                    setTimeout(() => {
                        notification.style.display = "none";
                    }, 1000);
                }
            }
        
            // Fetch CSRF token from cookies
            function getCSRFToken() {
                const match = document.cookie.match(/csrftoken=([\w-]+)/);
                return match ? match[1] : null;
            }
        
            showLoader();
            // Extract data from URL
            const { patientId, patientName, testDate, reportDate, location } = extractDataFromURL();
            const filename = `${patientId.replace(/\s+/g, "_")}_${patientName.replace(/\s+/g, "_")}.pdf`;
            
            // Get baseImage from the DOM instead of the URL
            const baseImageElement = document.getElementById("baseImage");
            if (!baseImageElement || !baseImageElement.src) {
                console.error("❌ Base image not found in DOM.");
                alert("Base image is missing.");
                hideLoader();
                return;
            }
            const reportImage = baseImageElement.src;
            console.log("✅ Using baseImage:", reportImage);

            const data = document.getElementById("show");
        
            if (!data) {
                console.error("Editor content not found.");
                hideLoader();
                showNotification("Error: No data found.");
                return;
            }
        
            const table = data.querySelector("table");
            data.classList.add("ck-blurred");
            data.classList.remove("ck-focused");
        
        
            async function loadImageAndRenderPDF() {
                try {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({ orientation: "portrait", unit: "px", format: "a4" });
        
                    const pageWidth = pdf.internal.pageSize.width;
                    const pageHeight = pdf.internal.pageSize.height;
        
                    // Load and rotate the image
                    const img = new Image();
                    img.src = reportImage;
                    img.crossOrigin = "Anonymous";
        
                    await new Promise((resolve, reject) => {
                        img.onload = resolve;
                        img.onerror = reject;
                    });
        
                    console.log("✅ Image loaded successfully!");
        
                    // Create a canvas to rotate the image
                    const canvas = document.createElement("canvas");
                    const ctx = canvas.getContext("2d");
        
                    canvas.width = img.height;
                    canvas.height = img.width;
        
                    ctx.translate(canvas.width / 2, canvas.height / 2);
                    ctx.rotate(90 * Math.PI / 180);
                    ctx.drawImage(img, -img.width / 2, -img.height / 2);
        
                    const rotatedImage = canvas.toDataURL("image/png");
                    console.log("✅ Rotated image generated!");
        
                    // Adjust image size for the PDF
                    let newWidth = pageWidth;
                    let newHeight = (img.height / img.width) * newWidth * 1.75;
        
                    if (newHeight > pageHeight) {
                        newHeight = pageHeight;
                        newWidth = (img.width / img.height) * newHeight;
                    }
        
                    // Center the image
                    const xPos = (pageWidth - newWidth) / 2;
                    const yPos = (pageHeight - newHeight) / 2;
        
                    pdf.addImage(rotatedImage, "PNG", xPos, yPos, newWidth, newHeight);
                    console.log("✅ Image added to PDF!");
        
                    // Add second page with the report
                    pdf.addPage();
                    const canvasReport = await html2canvas(data, { scale: 2, useCORS: true });
                    const reportImgData = canvasReport.toDataURL("image/jpeg", 0.98);
                    //used for copy the text
                           
                    const textContent = data.innerText || data.textContent;
    
                    if (!textContent.trim()) {
                        console.warn("⚠️ No text found in 'show' element.");
                    }
        
                    // Set font to monospaced (prevents structure distortion)
                    pdf.setFont("courier", "normal"); // Use 'courier' for fixed-width font
                    pdf.setFontSize(12);
        
                    const margin = 5;
                    const maxWidth = pageWidth - 1 * margin;
                    const textLines = pdf.splitTextToSize(textContent, maxWidth);
                    pdf.setTextColor(255, 255, 255); // Set text color to white (invisible on white background)
                    pdf.text(textLines, margin, margin + 10);
                    //end of copy text
                    pdf.addImage(reportImgData, "JPEG", 10, 120, pageWidth - 20, pageHeight - 300);
        
                    console.log("✅ Report added to second page!");
        
                    // Convert PDF to Blob
                    const pdfBlob = pdf.output("blob");
        
                    if (!patientId) {
                        console.error("Patient ID not found in URL.");
                        hideLoader();
                        showNotification("Error: Missing patient ID.");
                        return;
                    }
        
                    const csrfToken = getCSRFToken();
                    if (!csrfToken) {
                        console.error("CSRF token not found.");
                        hideLoader();
                        showNotification("Error: Authentication failed.");
                        return;
                    }
        
                    // Prepare form data
                    const formData = new FormData();
                    formData.append("pdf", pdfBlob, filename);
                    formData.append("patientId", patientId);
                    formData.append("patientName", patientName);
                    formData.append("testDate", testDate);
                    formData.append("reportDate", reportDate);
                    formData.append("location", location);
        
                    // Upload PDF via API
                    const response = await fetch("/upload_ecg_pdf/", {
                        method: "POST",
                        headers: {
                            "X-CSRFToken": csrfToken,
                        },
                        body: formData,
                    });
                    handleDone().catch(console.error);
                    if (response.ok) {
                        console.log("✅ PDF successfully sent to backend.");
                        showNotification("PDF successfully uploaded!");
                        setTimeout(() => {
                            window.location.href = document.referrer + "?nocache=" + Date.now();
                        }, 2000);
                    } else {
                        console.error("❌ Failed to upload PDF.");
                        showNotification("Error uploading PDF. Please try again.");
                    }
                } catch (error) {
                    console.error("❌ Error generating PDF:", error);
                    showNotification("Error processing PDF.");
                } finally {
                    hideLoader();
                }
            }
        
            loadImageAndRenderPDF();
        }

        // Initialize page
        window.onload = function() {
            const data = getQueryParams();

            // Initially display Reporting Bot View
            document.getElementById('viewSelect').value = 'reporting-bot';
            updateReportingBotView();

            // Set ECG image in both views
            
            document.getElementById('ecgImage').src = data.reportImage;
            initializeEventListeners();
            switchView();
        };

    </script>
</body>
</html>