<!DOCTYPE html>
<html>
{% load tz %} {% load static %}

<head>
  <title>XRAi Allocation</title>
  <link rel="stylesheet" href="{% static 'resource/css/main.css' %}" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
  <!-- Include necessary libraries -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/cornerstone-core@latest/dist/cornerstone.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/cornerstone-wado-image-loader@latest/dist/cornerstoneWADOImageLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/cornerstone-tools@latest/dist/cornerstoneTools.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>

  <style>
    a.pdfButton {
      display: inline-block;
      padding: 3px 5px;
      background-color: #4CAF50; /* Green color */
      color: #ffffff;
      text-decoration: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
      font-size: 14px;
    }
    
    a.pdfButton:hover {
      background-color: #45a049; /* Darker green */
    }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      min-height: 100vh;
      flex-direction: column;
    }

    .modal-content {
      border-radius: 10px;
    }

    /* Optional: Styles for button positioning */
    .card {
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      border-radius: 10px;
    }
    .modal-body {
      max-height: 400px; /* Set the max height to suit your design */
      overflow-y: auto;  /* Enable vertical scrolling */
    }
    
    /* Optional: Ensure the modal size is constrained */
    .modal-dialog {
      max-width: 600px; /* Adjust this to set a fixed width for the modal */
      width: 100%;      /* Allow full width within the max-width constraint */
    }

    .container {
      margin: 0 auto;
      width: 100%;
      max-width: 100%;
      padding-left: 5px;
      padding-right: 5px;
    }

    .card {
      border: none;
      border-radius: 7px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      margin-bottom: 3px;
      position: sticky;
      top: 0;
      z-index: 1;
      background-color: #fff;
    }

    .card-body {
      padding: 10px;
    }

    #count1 {
      padding: 10px;
      font-size: 25px;
      color: black;
    }

    #count2 {
      padding: 10px;
      font-size: 25px;
      color: black;
    }

    #totalRowCount {
      color: orange;
    }

    #reportedRowCount {
      color: green;
    }

    .header {
      margin-bottom: 5px;
      background-color: #fff;
      z-index: 10;
      position: sticky;
      top: 60px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background-color: #ccc;
    }

    th,
    td {
      padding: 5px;
      text-align: center;
      border-bottom: 1px solid #ccc;
    }

    th:last-child,
    td:last-child {
      border-right: none;
    }

    th:first-child,
    td:first-child {
      position: sticky;
      left: 0;
      background-color: #fff;
      z-index: 1;
    }

    td:first-child {
      z-index: 2;
    }

    .table-container {
      height: 100%;
      overflow-y: auto;
    }

    .dropdown-select {
      position: relative;
    }

    .dropdown-select select {
      width: 100%;
      padding: 5px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    .dropdown-select select:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 5px #007bff;
    }

    .dropdown-select1 {
      position: relative;
    }

    .dropdown-select1 select {
      width: 70%;
      padding: 5px;
      font-size: 12px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    .dropdown-select1 select:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 5px #007bff;
    }

    .greeting {
      margin-top: 18px;
      text-align: right;
      font-weight: bold;
      float: right;
      color: black;
    }

    .search-container {
      margin-top: 7px;
      margin-right: 270px;
      font-weight: bold;
      float: right;
      position: sticky;
      display: flex;
      justify-content: center;
    }

    .allocate-button {
      background-color: white;
      color: black;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
    }

    .footer {
      background-color: #f7f7f7;
      padding: 10px 0;
      text-align: center;
      margin-top: auto;
    }

    .filter-dropdown-container {
      display: flex;
      align-items: center;
    }

    .filter-dropdown-container>div {
      margin-right: 3px;
      /* Adjust this value to control the space between the "Date" header and the dropdown */
    }

    a.reportButton {
      color: white;
      background-color: #ffa500;
      border: none;
      border-radius: 5px;
      padding: 5px 10px;
      font-size: 15px;
      cursor: pointer;
      text-decoration: none;
      /* Add this line to remove underline */
      transition: background-color 0.3s;
    }

    a.reportButton:hover {
      background-color: #ff8c00;
      /* Change to the desired darker orange color on hover */
      text-decoration: none;
    }


    .hidden-row {
      display: none;
    }

    .btn-custom-sm {
      padding: 5px;
      font-size: 11px;
      border-radius: 4px;
      background-color: #ff0000;
      color: #ffffff;
      border: none;
      cursor: pointer;
    }

    .scroll-to-top {
      position: fixed;
      bottom: 30px;
      right: 30px;
      display: none;
    }

    .scroll-to-top a {
      display: block;
      width: 40px;
      height: 40px;
      background-color: green;
      border-radius: 50%;
      color: #ffffff;
      font-size: 20px;
      text-align: center;
      line-height: 40px;
      text-decoration: none;
    }

    .refresh {
      background-color: black;
      color: white;
      padding: 3px 7px;
      border: none;
      border-radius: 5px;
      font-size: 12px;
    }

    .popup {
      display: none;
      position: fixed;
      bottom: 30px;
      right: 30px;
      background-color: orange;
      color: white;
      padding: 10px 15px;
      border-radius: 5px;
      z-index: 1000;
      max-width: 300px;
      /* Adjust the maximum width as needed */
      width: auto;
      /* Set width to auto or a specific value based on your design */
    }

    .popup-content {
      font-size: 14px;
      /* You can also set a max-width for the content if needed */
      max-width: 100%;
      overflow: hidden;
      /* Hide content overflow if it exceeds the max-width */
    }

    .small-popup {
      display: none;
      position: absolute;
      background-color: white;
      color: black;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      max-width: 300px;
      /* Adjust the maximum width as needed */
      width: auto;
      /* Set width to auto or a specific value based on your design */
    }

    /* Apply 3D effect on hover */
    .unallocate-button {
      transition: transform 0.3s;
    }

    .unallocate-button:hover {
      transform: translateY(-3px) translateZ(0);
      /* Adjust the values for the desired 3D effect */
    }

    #patientTable {
      width: 100vw;
      background-color: white;
      color: black;
    }

    #myInput {
      padding: 5px;
      font-size: 15px;
      width: 230px;

    }

    #myInput::placeholder {
      color: #999;
      /* Adjust the color as needed */
    }

    .openClinicalHistoryButton {
      padding: 3px 5px;
      font-size: 14px;
      background-color: blue;
      color: #fff;
      /* White text color */
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .openClinicalHistoryButton:hover {
      background-color: #0056b3;
    }

    a.imageButton {
      display: inline-block;
      padding: 3px 5px;
      background-color: brown;
      color: #ffffff;
      text-decoration: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    a.imageButton:hover {
      background-color: #8B4513;
      /* Change to the desired darker brown color */
      color: #ffffff;
      text-decoration: none;
    }

    .row-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .row-container1 {
      display: flex;
    }

    .count-container {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      background-color: yellow;
      border-radius: 5px;
      font-family: 'Arial', sans-serif;
      margin-left: 10px;
    }

    .count-container1 {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        background-color: green;
        border-radius: 5px;
        font-family: 'Arial', sans-serif;
      }



    #count1,
    #count2,
    .greeting {
      margin-right: 10px;
      margin-left: 10px;
      padding: 0px;
      font-size: 12px;
    }

    #totalRowCount,
    #reportedRowCount {
      color: black;
    }

    #myInput {
      padding: 8px;
      font-size: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
      width: 250px;
    }

    dropdown-menu {
        background-color: #f8f9fa; /* Example: Change background color of dropdown menu */
        border: 1px solid #ced4da; /* Example: Add border to dropdown menu */
    }

    /*for allocation*/
    .form-container {
        background-color: #fff;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        max-width: 600px;
        margin: auto;
    }

    .form-container h2 {
        text-align: center;
        color: #333;
        margin-bottom: 20px;
    }

    label {
        display: block;
        font-weight: bold;
        margin-bottom: 8px;
        color: #555;
    }

    select {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        border: 1px solid #ccc;
        font-size: 14px;
        color: #333;
    }

    select:focus, button:focus {
        border-color: #007bff;
        outline: none;
    }

    button {
        background-color: #007bff;
        color: white;
        cursor: pointer;
        font-size: 14px;
        border: none;
        max-height: 50px;

        margin-left:3px;
    }

    button:hover {
        background-color: #0056b3;
    }

    .button-group {
        display: flex;
        justify-content: space-between;
        gap: 10px;
    }

    .button-group button {
        width: 48%;
    }

    .select-group {
        margin-bottom: 20px;
    }

    .form-container {
        background-color: #fff;
        padding: 5px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        max-width: 100%;
        margin: auto;
    }

    .form-container h2 {
        text-align: center;
        color: #333;
        margin-bottom: 10px;
    }

    label {
        display: block;
        font-weight: bold;
        margin-bottom: 8px;
        color: #555;
    }

    /* Layout for larger screens (side by side) */
    .form-group {
        display: flex;
        justify-content: space-between;
        gap: 20px;
        flex-wrap: wrap;
    }

    .form-group .select-group {
        flex: 1;
    }

    .form-group .button-group {
        flex: 1;
    }

    .button-group {
        display: flex;
        justify-content: space-between;
        gap: 10px;
    }


  </style>
</head>

<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">XRAi Allocation</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-end" id="navbarSupportedContent">
                <ul class="navbar-nav">
                    <li>     
                      <div class="greeting text-white" id="greeting">
                        {% if user %}
                        <h6>
                          <strong>{{ user.first_name }}</strong>,
                          <span id="greeting-text"></span>
                        </h6>
                        {% endif %}
                      </div>
                    </li>
                    <li class="nav-item dropdown">


                        <button type="button" class="btn btn-info btn-sm mt-2 dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                            Action
                          </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                            <li><a class="dropdown-item" href="xray_pdf_report/">Xray Reports</a></li>
                            <li><a class="dropdown-item" href="vitals_pdf_report/">Vitals Reports</a></li>
                            <li><a class="dropdown-item" href="optometry_pdf_report/">Optometry Reports</a></li>
                            <li><a class="dropdown-item" href="audiometry_pdf_report/">Audiometry Reports</a></li>
                            <li><a class="dropdown-item" href="#" onclick="downloadExcel()">Get Excel</a></li>
                            <li><a class="dropdown-item" href="get_excel">Get Excel(Observation)</a></li>
                            <li> <a class="dropdown-item" href="/allocate1">Allocate</a></li>
                            <li> <a class="dropdown-item" href="/allocatecoordinator1">Allocate to Corporate Coordinator</a></li>
                            <li> <a class="dropdown-item" href="/reporting_status">Reporting Status</a></li>
                            
                        </ul>
                    <li class="nav-item ms-3">
                  <a class="btn btn-primary btn-sm mt-2" href="{% url 'coordinator_dashboard' %}" target="_blank">Live Support</a>
                    </li>

                        <li class="nav-item dropdown">
  <button type="button" class="btn btn-warning btn-sm mt-2 dropdown-toggle" data-bs-toggle="dropdown">
    FAQ
  </button>
  <ul class="dropdown-menu dropdown-menu-end">
   <li><a class="dropdown-item" href="{% url 'create_faq' %}">Create FAQ</a></li>
    <li><a class="dropdown-item" href="{% url 'view_faq' %}">View FAQ</a></li>
  </ul>
</li>
                    </li>
                    <li class="nav-item">
                        <a href="/logout" class="nav-link">
                            <button class="logout-button btn btn-sm btn-danger"><strong>Logout</strong></button>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>



  <div class="container">
    <div id="clinicalHistoryPopup" class="small-popup">
      <span class="popup-content"></span>
    </div>

    <div class="row">
      <div class="col">
        <div class="card">
          <div class="card-body">
            <div class="row-container1">
                <div class="count-container1">
                  <span id="count1">Current Uploaded: <strong><span id="totalRowCount">{{ total.total_uploaded }}</span></strong></span>
                  <span id="count1">Current Reported: <strong><span id="totalRowCount">{{ total.current_reported }}</span></strong></span>
                  <span id="count1">Unreported Cases: <strong><span id="totalRowCount">{{ total.unreported_cases }}</span></strong></span>
                  <span id="count1">Unallocated Cases: <strong><span id="totalRowCount">{{ total.unallocated_cases }}</span></strong></span>
                  <span id="count1">Nonreported Cases: <strong><span id="totalRowCount">{{ total.nonreported_cases }}</span></strong></span>
                </div>
                <div class="count-container">
                  <div class="filtered-count-container">
                      <span id="count1">Filtered Row Count: <strong><span id="filteredRowCount">0</span></strong></span>
                  </div>
                </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col">
        <div class="card">
          <div class="card-body">      
            <div class="pagination row">
              <span class="step-links col">
                {% if page_obj.has_previous %}
                    <a href="?page=1">&laquo; first</a>
                    <a href="?page={{ page_obj.previous_page_number }}">previous</a>
                {% endif %}
              
                <span class="current">
                    Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}.
                </span>
              
                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}">next</a>
                    <a href="?page={{ page_obj.paginator.num_pages }}">last &raquo;</a>
                {% endif %}
              </span>
              <!-- Search Page Input -->
              <div class="col">
                <form action="" method="GET" class="d-flex" onsubmit="return goToPage();">
                  <input type="number" class="form-control me-2" id="pageInput" name="page" 
                         min="1" max="{{ page_obj.paginator.num_pages }}" 
                         placeholder="Enter page no Search" required>
                  <button class="btn btn-primary" type="submit">Go</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col">
        <div class="card">
          <div class="card-body">      
            <div class='search-google'>
              <form method="GET" class="d-flex">
                <input type="text" 
                       name="q" 
                       class="form-control me-2" 
                       placeholder="Search all records..." 
                       value="{{ request.GET.q }}">
                <button class="btn btn-primary" type="submit">Search</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-body">
        {% if messages %}
          <div id="django-messages">
            {% for message in messages %}
              <div 
                class="alert 
                       {% if message.tags == 'error' %}alert-danger
                       {% elif message.tags == 'success' %}alert-success
                       {% else %}alert-info{% endif %}">
                {{ message }}
              </div>
            {% endfor %}
          </div>
        {% endif %}

        <form method="POST" action="{% url 'assign_radiologist' %}" id="radiologistForm">
          {% csrf_token %}
          <div class="form-container row">
            <div class="form-group col">
              <div class="select-group">
                <label for="radiologist-select">Assign Radiologist:</label>
                <select id="radiologist-select" name="radiologist" class="form-control">
                  <option value="">--Select Radiologist--</option>
                  {% for radiologist in radiologists %}
                    <option value="{{ radiologist.id }}">{{ radiologist.first_name }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="button-group">
                <button type="submit" name="action" value="assign">Assign Radiologist</button>
                <button type="submit" name="action" value="replace">Replace Radiologist</button>
              </div>
            </div>
            <div class="form-group col">
              <!-- <button type="submit">Assign Radiologist</button> -->
              <div class="select-group">
                <label for="corporatecoordinator-select">Assign Corporate Coordinator:</label>
                <select id="corporatecoordinator-select" name="corporatecoordinator" class="form-control">
                  <option value="">--Select Corporate Coordinator--</option>
                  {% for coordinator in corporatecoordinators %}
                    <option value="{{ coordinator.id }}">{{ coordinator.first_name }}</option>
                  {% endfor %}
                </select>
              </div>
          
          
              <!-- Buttons -->
              <div class="button-group">
                <button type="submit" name="action" value="assign_corporate">Assign Coordinator</button>
                <button type="submit" name="action" value="replace_corporate">Replace Coordinator</button>
              </div>
            </div>
          
        
          
          </div>
          
        <div class="table-container">
          <table id="patientTable">
            <thead>
              <tr>
                <th>
                  <input type="checkbox" id="masterCheckbox" />
                </th>
                <th>Patient ID</th>
                <th>Patient Name</th>
                <th>Age</th>
                <th>Gender</th>
                <th>
                  <div class="filter-dropdown-container">
                      <div>Study Date</div>
                        <div class="dropdown-select1" id="filter-date-dropdown-date">
                            <select id="filter-date-select-date" class="form-control">
                                <option value="">All</option>
                                {% for date in Date %}
                                    <option value="{{ date }}">{{ date }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </th>
                <th>
                   <div class="filter-dropdown-container">
                        <div>Study Time</div>
                        <div class="dropdown-select1" id="filter-studytime-dropdown">
                            <select id="filter-studytime-select-studytime" class="form-control">
                                <option value="">All</option>
                                {% for studytime in Study_time %}
                                    <option value="{{ studytime }}">{{ studytime }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </th>
                <!--28-05-2025-->
                <th>
                  <div class="filter-dropdown-container">
                      <div>Received Date</div>
                      <div class="dropdown-select1" id="filter-Received-dropdown">
                          <select id="filter-Received-select-Received" class="form-control">
                              <option value="">All</option>
                              {% for received in Received_on_db %}
                                  <option value="{{ received|date:'Y-m-d' }}">{{ received|date:'Y-m-d' }}</option>
                              {% endfor %}
                          </select>
                      </div>
                  </div>
              </th>
              <!--update by rohan jangid -->
                <th>
                  <div class="filter-dropdown-container">
                       <div>Institution</div>
                       <div class="dropdown-select1" id="filter-institution_name-dropdown">
                           <select id="filter-institution_name-select-institution_name" class="form-control">
                               <option value="">All</option>
                               {% for institution_name in Institution %}
                                   <option value="{{ institution_name }}">{{ institution_name }}</option>
                               {% endfor %}
                           </select>
                       </div>
                   </div>
               </th>

                <th>
                  <div class="filter-dropdown-container">
                     <div>Modality</div>
                     <div class="dropdown-select1" id="filter-Modality-dropdown">
                         <select id="filter-Modality-select-Modality" class="form-control">
                             <option value="">All</option>
                             {% for Modality in Modalities %}
                                 <option value="{{ Modality }}">{{ Modality }}</option>
                             {% endfor %}
                         </select>
                     </div>
                  </div>
                </th>
                <th>
                  <div class="filter-dropdown-container">
                      <div>Study Description</div>
                      <div class="dropdown-select1" id="filter-Studydescription-dropdown-Studydescription">
                          <select id="filter-Studydescription-select-Studydescription" class="form-control">
                              <option value="">All</option>
                              {% for Studydescription in Study_description %}
                                  <option value="{{ Studydescription }}">{{ Studydescription }}</option>
                              {% endfor %}
                          </select>
                      </div>
                  </div>
                </th>
                <th>
                  <div class="filter-dropdown-container">
                      <div>Body Part</div>
                      <div class="dropdown-select1" id="filter-bodypart-dropdown-bodypart">
                          <select id="filter-bodypart-select-bodypart" class="form-control">
                              <option value="">All</option>
                              {% for bodypart in body_part_examined %}
                                  <option value="{{ bodypart }}">{{ bodypart }}</option>
                              {% endfor %}
                          </select>
                      </div>
                  </div>
                </th>
                <th>
                  <div class="filter-dropdown-container">
                      <div>Coordinator</div>
                      <div class="dropdown-select1" id="filter-coordinator-dropdown-coordinator">
                          <select id="filter-coordinator-select-coordinator" class="form-control">
                              <option value="">All</option>
                              {% for corporatecoordinator in corporatecoordinators %}
                                  <option value="{{ corporatecoordinator.first_name }}">{{ corporatecoordinator.first_name }}</option>
                              {% endfor %}
                          </select>
                      </div>
                  </div>
              </th>
                <th>
                    <div class="filter-dropdown-container">
                        <div>Allocated</div>
                        <div class="dropdown-select1" id="filter-allocate-dropdown-allocate">
                            <select id="filter-allocate-select-allocate" class="form-control">
                                <option value="">All</option>
                                <option value="Unassigned">Unassigned</option> 
                                {% for radiologist in radiologists %}
                                    <option value="{{ radiologist.first_name }}">{{ radiologist.first_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </th>
                
                <th>Clinical History</th>
                <th>History Files</th>
                <th>Mark As Urgent</th>
                <th>Mark As MLC</th>
                <th>Mark As VIP</th>
                <th>Mark for Review</th>
                <th>Image</th>
                <th>Report</th>
                <!--THE UPDATE FROM ROHAN JANGID-->
                <th>
                  <div class="filter-dropdown-container">
                      <div>Status</div>
                      <div class="dropdown-select1" id="filter-status-dropdown">
                          <select id="filter-status-select" class="form-control">
                              <option value="">All</option>
                              <option value="reported" {% if status_filter == 'reported' %}selected{% endif %}>Reported</option>
                              <option value="unreported" {% if status_filter == 'unreported' %}selected{% endif %}>Unreported</option>
                              <option value="nonreported" {% if status_filter == 'nonreported' %}selected{% endif %}>Nonreported</option>
                          </select>
                      </div>
                  </div>
              </th>
                <th>Mark for Non Reported</th>
              <!-- Add a column for the "Report" button -->
                <th>Action</th>
              </tr>
        </thead>
        <tbody>
          {% for patient in patients %}
          <tr class="patientRow" id="{{ patient.patient_id }}">
            <td>
              <input type="checkbox" class="patientCheckbox" name="patients" value="{{ patient.id }}" />
            </td>
            <td>{{ patient.patient_id }}</td>
            <td>{{ patient.patient_name }}</td>
            <td>{{ patient.age }}</td>
            <td>{{ patient.gender }}</td>
            <td>{{ patient.study_date }}</td>
            <td>{{ patient.study_time }}</td>
            <td>{{ patient.recived_on_db|date:'Y-m-d' }}</td> <!--28-05-2025 update by rohan jangid-->
            <td>{{ patient.institution_name }}</td>
            <td>{{ patient.Modality }}</td>
            <td>{{ patient.study_description }}</td>
            <td>{{patient.body_part_examined}}</td>
            <td data-corporatecoordinator="{{ corporatecoordinator.user.id }}">
                {% for corporatecoordinator in patient.corporatecoordinator.all %}
                    {{ corporatecoordinator.user.first_name }}
                    {% if not forloop.last %}, {% endif %}
                {% endfor %}
            </td>
            <!-- <td data-radiologist="{{ radiologist.user.id }}">
                {% for radiologist in patient.radiologist.all %}
                    {{ radiologist.user.first_name }}
                    {% if not forloop.last %}, {% endif %}
                {% endfor %}
                {% if patient.radiologist_assigned_at %}
                  <br>
                  <small class="text-muted">
                    Assigned: {{ patient.radiologist_assigned_at|date:"Y-m-d H:i" }}
                  </small>
                {% endif %}
            </td> -->
            <td data-radiologist="{% for radiologist in patient.radiologist.all %}{{ radiologist.user.first_name }}{% if not forloop.last %},{% endif %}{% endfor %}">
                {% for radiologist in patient.radiologist.all %}
                    {{ radiologist.user.first_name }}
                    {% if not forloop.last %}, {% endif %}
                {% endfor %}
                {% if patient.radiologist_assigned_at %}
                    <br>
                    <small class="text-muted">
                        Assigned: {{ patient.radiologist_assigned_at|date:"Y-m-d H:i" }}
                    </small>
                {% endif %}
            </td>
            <td>
              {{ patient.notes|linebreaksbr }}
              {% if patient.notes_modified_at %}
                <br>
                <small class="text-muted">Last modified: {{ patient.notes_modified_at|date:"Y-m-d H:i" }}</small>
              {% endif %}
            </td>

            <td>
              {% for file in patient.history_file_infos %}
                <a class="imageButton" target="_blank" href="{{ file.url }}">
                  History Files {{ forloop.counter }}
                </a>
                {% if file.uploaded_at %}
                  <br>
                  <small class="text-muted">
                    Uploaded: {{ file.uploaded_at|date:"Y-m-d H:i" }}
                  </small>
                {% endif %}
                <br>
              {% endfor %}
            </td>

            <td>
              <input type="checkbox" class="urgent-checkbox" data-patient-id="{{ patient.patient_id }}" 
                  {% if patient.urgent %}checked{% endif %}>
            </td>
            <td>
              <input type="checkbox" class="mlc-checkbox" data-patient-id="{{ patient.patient_id }}" 
                  {% if patient.Mlc %}checked{% endif %}>
            </td>
            <td>
              <input type="checkbox" class="vip-checkbox" data-patient-id="{{ patient.patient_id }}" 
                  {% if patient.vip %}checked{% endif %}>
            </td>
            <td>
              <input type="checkbox" class="twostepcheck-checkbox" data-patient-id="{{ patient.patient_id }}" 
                  {% if patient.twostepcheck %}checked{% endif %}>
            </td>
            <td>
              <a class="reportButton"
                 href="reporting-bot?data-patientid={{ patient.patient_id }}&data-patientname={{ patient.patient_name }}&data-study-id={{ patient.study_id }}&data-age={{ patient.age }}&data-gender={{ patient.gender }}&data-institution_name={{ patient.institution_name }}&data-testdate={{ patient.study_date }}&data-reportdate={% now 'Y-m-d' %}&data-reportimage={{ patient_url.urls.0|urlencode }}&data-dicom-file={% get_media_prefix %}{{ patient.dicom_file }}&data-location={{ patient.location }}&data-accession={{ patient.accession_number }} &data-studydescription={{ patient.study_description }}&data-studyInstanceUID={{ patient.study_instance_uid }}"
                 data-patient-id="{{ patient.patient_id }}" data-patientname="{{ patient.patient_name }}"
                 data-age="{{ patient.age }}" data-gender="{{ patient.gender }}"
                 data-institution_name="{{ patient.institution_name }}"
                 data-testdate="{{ patient.study_date }}" data-reportdate="{% now 'Y-m-d' %}"
                 data-reportimage="{{ patient_url.urls.0|urlencode }}"
                 data-dicom-file="{% get_media_prefix %}{{ patient.dicom_file }}"
                 data-location="{{ patient.location }}"
                 data-study-id="{{patient.study_id}}"
                 data-studydescription="{{patient.study_description}}"
                 &data-studyInstanceUID="{{ patient.study_instance_uid }}"
                 data-accession="{{ patient.accession_number }}" onclick="changeButtonColor(this);">
                  View Image
              </a>
            </td>
            <!-- Add this cell in each patient row -->
            <td>
              {% for pdf_url in patient.presigned_pdf_urls %}
                <a class="pdfButton" target="_blank" href="{{ pdf_url }}">
                  View Report {{ forloop.counter }}
                </a>
                <br>
              {% empty %}
                No PDF
              {% endfor %}
            </td>
            <td>
                {% if patient.NonReportable %}
                    nonreported
                {% elif patient.isDone %}
                    Reported
                {% else %}
                    Unreported
                {% endif %}
            </td>
            <!-- <td>
              <input type="checkbox" class="NonReportable-checkbox" data-patient-id="{{ patient.patient_id }}" 
                  {% if patient.NonReportable %}checked{% endif %}>
            </td> -->
            <td>
              <input type="checkbox" class="NonReportable-checkbox" data-patient-id="{{ patient.patient_id }}"
                  {% if patient.NonReportable %}checked{% endif %} onclick="handleCheckboxClick(this)">
            </td>
            <!-- <td>
                <button id="alertButton-{{ patient.patient_id }}" style="display: none;" class="alert-button" onclick="markReported(this)">
                    Alert
                </button>
            </td> -->
            <td>
              <button type="button" class="btn btn-sm btn-custom" onclick="openEditModal({{ patient.id }})">Edit</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
        </table>
      </form>
      </div>
      <div id="reportingBotContainer"></div>
      <div id="dicomViewer"></div>

      <div class="scroll-to-top">
        <a href="#top"><i class="fa fa-arrow-up"></i></a>
      </div>
    </div>
  </div>
  </div>

  <!-- Modal for Edit Form -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editModalLabel">Edit DICOM Data</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="editForm">
              {% csrf_token %}
              <input type="hidden" id="dicomId" />
              <div class="mb-3">
                <label for="patient_id" class="form-label">Patient Id:</label>
                <input type="text" class="form-control" id="patient_id"/>
              </div>
              <div class="mb-3">
                <label for="patient_name" class="form-label">Name:</label>
                <input type="text" class="form-control" id="patient_name"/>
              </div>
              
              <div class="mb-3">
                <label for="age" class="form-label">Age:</label>
                <input type="text" class="form-control" id="age"/>
              </div>
              <div class="mb-3">
                <label for="gender" class="form-label">Gender:</label>
                <input type="text" class="form-control" id="gender"/>
              </div>
              <div class="mb-3">
                <label for="study_description" class="form-label">Study Description:</label>
                <input type="text" class="form-control" id="study_description"/>
              </div>
              <div class="mb-3">
                <label for="bodypart" class="form-label">Body Part:</label>
                <input type="text" class="form-control" id="bodypart"/>
              </div>
              <div class="mb-3">
                <label for="notes" class="form-label">clinical history:</label>
                <input type="text" class="form-control" id="notes"/>
              </div>
              </div>
              

              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveEdit()">Save changes</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>


  <!-- Include necessary libraries -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/cornerstone-core@latest/dist/cornerstone.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/cornerstone-wado-image-loader@latest/dist/cornerstoneWADOImageLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/cornerstone-tools@latest/dist/cornerstoneTools.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
 

  <script>
    setTimeout(() => {
      const messages = document.getElementById("django-messages");
      if (messages) {
        messages.style.display = "none";
      }
    }, 5000);
  </script>

  <script>
    function openEditModal(id) {
        $("#dicomId").val(id);
        const row = $("tr:has(button[onclick='openEditModal(" + id + ")'])");
        $("#patient_id").val(row.find("td:eq(1)").text());
        $("#patient_name").val(row.find("td:eq(2)").text());
        $("#age").val(row.find("td:eq(3)").text());
        $("#gender").val(row.find("td:eq(4)").text());
        $("#study_description").val(row.find("td:eq(10)").text());
        $("#bodypart").val(row.find("td:eq(11)").text());
        $("#notes").val(row.find("td:eq(14)").text());
        $('#editModal').modal('show');
      }


      function saveEdit() {
        const id = $("#dicomId").val();
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value; // Get the CSRF token
    
        // Prepare the form data, including files
        const formData = new FormData();
        formData.append('patient_id', $("#patient_id").val());
        formData.append('patient_name', $("#patient_name").val());
        formData.append('age', $("#age").val());
        formData.append('gender', $("#gender").val());
        formData.append('study_description', $("#study_description").val());
        formData.append('body_part_examined', $("#bodypart").val());
        formData.append('notes', $("#notes").val());
        formData.append('csrfmiddlewaretoken', csrftoken);
    
        // Make the POST request with FormData
        $.ajax({
            url: `/edit-dicom-data-coordinator/${id}/`,
            type: 'POST',
            data: formData,
            processData: false,  // Don't process the data
            contentType: false,  // Don't set content type
            success: function (response) {
                if (response.success) {
                    location.reload();
                } else {
                    alert("Failed to update data!");
                }
            },
            error: function () {
                alert("Error while updating data!");
            }
        });
    }
  </script>
  <script>
    function goToPage() {
      var page = document.getElementById("pageInput").value;
      var totalPages = {{ page_obj.paginator.num_pages }};
      
      if (page >= 1 && page <= totalPages) {
        window.location.href = "?page=" + page;
      } else {
        alert("Please enter a valid page number between 1 and " + totalPages);
      }
      
      return false; // Prevent form submission
    }
  </script>
  
  <script>
    function handleCheckboxClick(checkbox) {
        var patientId = checkbox.getAttribute("data-patient-id");
        var alertButton = document.getElementById("alertButton-" + patientId);

        if (checkbox.checked) {
            alert("Please Confirm to Mark as NonReported.");
            alertButton.style.display = "block"; // 
        } else {
            alertButton.style.display = "none"; 
        }
    }

    function markReported(button) {
        button.innerText = "Reported"; 
        button.disabled = true; 
        alert("Reported successfully!"); 
    }
  </script>
  <script>
   
    document.addEventListener("DOMContentLoaded", function() {
      const csrfToken = '{{ csrf_token }}'; // CSRF token for Django
  
      // Function to handle checkbox changes
      function handleCheckboxChange(checkboxClass, endpoint) {
          document.querySelectorAll(`.${checkboxClass}`).forEach(function(checkbox) {
              checkbox.addEventListener('change', function() {
                  const patientId = this.getAttribute('data-patient-id');
                  const isChecked = this.checked;
  
                  console.log(`Checkbox for Patient ID ${patientId} (${checkboxClass}) is now ${isChecked ? 'checked' : 'unchecked'}.`);
  
                  // Send AJAX request to update status in the database
                  fetch(`/${endpoint}/${patientId}/`, {
                      method: 'POST',
                      headers: {
                          'Content-Type': 'application/json',
                          'X-CSRFToken': csrfToken,
                      },
                      body: JSON.stringify({ status: isChecked })
                  })
                  .then(response => {
                      if (!response.ok) {
                          throw new Error('Network response was not ok');
                      }
                      return response.json();
                  })
                  .then(data => {
                      if (data.success) {
                          console.log(`Successfully updated ${checkboxClass} status for Patient ID ${patientId} to ${isChecked}.`);
                      } else {
                          console.error(`Failed to update ${checkboxClass} status for Patient ID ${patientId}: ${data.error}`);
                      }
                  })
                  .catch(error => {
                      console.error('Error during update:', error);
                      // Revert checkbox state if there was an error
                      this.checked = !isChecked;
                      console.log(`Reverted checkbox for Patient ID ${patientId} (${checkboxClass}) due to an error.`);
                  });
              });
          });
      }
  
      // Initialize for both urgent and mlc checkboxes
      handleCheckboxChange('urgent-checkbox', 'update_urgent_status_xray');
      handleCheckboxChange('mlc-checkbox', 'update_mlc_status_xray');
      handleCheckboxChange('vip-checkbox', 'update_vip_status_xray');
      handleCheckboxChange('twostepcheck-checkbox', 'update_twostepcheck');
      handleCheckboxChange('NonReportable-checkbox', 'update_NonReportable');
  });
  
  
  
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
        const masterCheckbox = document.getElementById("masterCheckbox");
        const tableBody = document.querySelector("#patientTable tbody");
    
        // Function to get all visible checkboxes
        const getVisibleCheckboxes = () => {
            return Array.from(tableBody.querySelectorAll(".patientCheckbox")).filter(checkbox => {
                // Check if the parent row is visible
                const row = checkbox.closest("tr");
                return row && row.style.display !== "none";
            });
        };
    
        // Toggle visible checkboxes when master checkbox is clicked
        masterCheckbox.addEventListener("change", () => {
            const visibleCheckboxes = getVisibleCheckboxes();
            visibleCheckboxes.forEach(checkbox => {
                checkbox.checked = masterCheckbox.checked;
            });
        });
    
        // Update master checkbox status based on visible checkboxes
        tableBody.addEventListener("change", (event) => {
            if (event.target.classList.contains("patientCheckbox")) {
                const visibleCheckboxes = getVisibleCheckboxes();
                const allChecked = visibleCheckboxes.every(checkbox => checkbox.checked);
                masterCheckbox.checked = allChecked;
            }
        });
    });
    
  </script>

  <script>

      function downloadExcel() {
              /* Get the table data and convert it to a worksheet */
              var table = document.querySelector('#patientTable');
          
              if (!table) {
                  alert("Table not found! Please check the table ID.");
                  return;
              }
          
              // Clone the table to avoid modifying the original
              var clonedTable = table.cloneNode(true);
          
              // Remove elements with class "form-control" within elements with class "dropdown-select1"
              clonedTable.querySelectorAll('.dropdown-select1 .form-control').forEach(element => element.remove());
          
              // Convert table to worksheet
              var ws = XLSX.utils.table_to_sheet(clonedTable, { raw: true });
          
              // Loop through the sheet and force the institution name column to be text
              Object.keys(ws).forEach(cell => {
                  if (ws[cell].t === 'n' && typeof ws[cell].v === 'string' && ws[cell].v.includes("DOCTORS FOR YOU")) {
                      ws[cell].t = 's';  // Set the cell type to string
                  }
              });
          
              // Create a workbook containing the worksheet
              var wb = XLSX.utils.book_new();
              XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
          
              // Save the workbook as an Excel file
              XLSX.writeFile(wb, 'dashboard_data.xlsx');
          }


    $(document).ready(function () {
      let popupTimer;

      $(".openClinicalHistoryButton").hover(
        function (event) {
          // Show the clinical history data in a separate popup
          const clinicalHistoryData = $(this).data("clinical-history");
          showPopup("Clinical History", clinicalHistoryData, event);
        },
        function () {
          // Hide the popup after a short delay
          popupTimer = setTimeout(hidePopup, 300); // Adjust the delay as needed
        }
      );

      $(".openClinicalHistoryButton").mousemove(function (event) {
        // Clear the existing timer to prevent premature hiding
        clearTimeout(popupTimer);

        // Position the popup next to the cursor
        positionPopup(event);
      });

      function showPopup(title, content, event) {
        const popup = $("#clinicalHistoryPopup");
        const popupContent = $(".popup-content");

        // Set the title and content of the popup
        popupContent.html(`${content}`);

        // Position and display the small popup above the cursor
        positionPopup(event);
        popup.fadeIn();
      }


      function hidePopup() {
        // Hide the popup
        const popup = $("#clinicalHistoryPopup");
        popup.fadeOut();
      }

      function positionPopup(event) {
        // Position the small popup above the cursor
        const popup = $("#clinicalHistoryPopup");
        popup.css({
          top: event.pageY - popup.outerHeight() - 10, // Adjust the offset as needed
          left: event.pageX + 10, // Add an offset from the cursor
        });
      }
    });


    // Function to update the counts of rows with 'Report' and 'Reported' button states
      function updateRowCounts() {
        const totalRowCount = $("#patientTable tbody tr").length;
        const reportedRowCount = $(
          '#patientTable tbody tr .reportButton:contains("Reported")'
        ).length;

        // Update the counts on the web page
        $("#totalRowCount").text(totalRowCount);
        $("#reportedRowCount").text(reportedRowCount);
      }

      // Call the updateRowCounts function when the document is ready
      $(document).ready(function () {
        updateRowCounts();
      });
  </script>

  <script>
    function myFunction() {
      var input, filter, table, tr, td, i, txtValue;
      input = document.getElementById("myInput");
      filter = input.value.toUpperCase();
      table = document.getElementById("patientTable");
      tr = table.getElementsByTagName("tr");

      for (i = 1; i < tr.length; i++) {
        var found = false;
        var columns = tr[i].getElementsByTagName("td");
        for (var j = 0; j < columns.length - 1; j++) { // Exclude the last column (Actions)
          td = columns[j];
          if (td) {
            txtValue = td.textContent || td.innerText;
            if (txtValue.toUpperCase().indexOf(filter) > -1) {
              found = true;
              break;
            }
          }
        }
        if (found) {
          tr[i].style.display = "";
        } else {
          tr[i].style.display = "none";
        }
      }
    }
  </script>

  <script>
    function changeButtonColor(anchor) {
      const button = $(anchor); // Convert the anchor to a jQuery object
      const PatientId = String(button.data("patient-id")).trim(); // Remove leading and trailing spaces
      const patientName = String(button.data("patientname")).trim();
      const age = String(button.data("age")).trim();
      const gender = String(button.data("gender")).trim();
      const testDate = String(button.data("testdate")).trim();
      const reportDate = String(button.data("reportdate")).trim();
      const reportImage = String(button.data("reportimage")).trim();

      // Check the isDone status
      if (isDone) {
        // If isDone is true, the button should already be in 'reported' state
        return;
      }

      // If the button is not in 'reported' state, change its style
      button.addClass("reported");
      // Change the button text
      button.text("Reported");

      // Construct the URL with query parameters
      const redirectURL = `reporting-bot?data-patientid=${PatientId}&data-patientname=${patientName}&data-age=${age}&data-gender=${gender}&data-testdate=${testDate}&data-reportdate=${reportDate}&data-reportimage=${reportImage}`;

      // Redirect to the desired URL
      window.location.href = redirectURL;
    }
  </script>

  <script>

    // Function to show/hide the scroll-to-top button based on the scroll position
    function toggleScrollToTopButton() {
      var scrollToTopButton = $(".scroll-to-top");
      if ($(window).scrollTop() > 100) {
        scrollToTopButton.fadeIn();
      } else {
        scrollToTopButton.fadeOut();
      }
    }

    // Event handler for the scroll-to-top button click
    $(".scroll-to-top a").click(function (e) {
      e.preventDefault();
      $("html, body").animate({ scrollTop: 0 }, "fast");
    });

    // Event handler for the window scroll event
    $(window).scroll(function () {
      toggleScrollToTopButton();
    });

    toggleScrollToTopButton();

    function getGreeting() {
      var currentTime = new Date();
      var currentHour = currentTime.getUTCHours() + 6; //get Indian time
      var greetingText = document.getElementById("greeting-text");
      console.log(currentHour);
      if (currentHour >= 0 && currentHour < 12) {
        greetingText.textContent = "Good morning";
        console.log(greetingText.textContent);
      } else if (currentHour >= 12 && currentHour < 16) {
        greetingText.textContent = "Good afternoon";
        console.log(greetingText.textContent);
      } else {
        greetingText.textContent = "Good evening";
        console.log(greetingText.textContent);
      }
    }

    document.addEventListener("DOMContentLoaded", function () {
      getGreeting();
    });
  </script>
<!--BELOW CODE ROHAN JANGID-->
<script>
  // 28-05-2025 Update by Rohan Jangid
  $(document).ready(function () {
    $('#filter-date-select-date, #filter-studytime-select-studytime, #filter-Received-select-Received, #filter-institution_name-select-institution_name, #filter-Modality-select-Modality, #filter-Studydescription-select-Studydescription, #filter-bodypart-select-bodypart, #filter-allocate-select-allocate, #filter-coordinator-select-coordinator, #filter-status-select').change(function () {
        filterTable();
    });

    function extractDate(dateStr) {
        if (!dateStr) return "";
        
        let parsedDate = new Date(dateStr);
        if (!isNaN(parsedDate.getTime())) {
            return parsedDate.toISOString().split("T")[0]; // Extracts YYYY-MM-DD
        }

        // Fallback: If dateStr is "March 27, 2025, 3:08 p.m.", extract date part
        let dateParts = dateStr.split(",");
        if (dateParts.length > 0) {
            let rawDate = dateParts[0].trim();
            let fallbackDate = new Date(rawDate);
            if (!isNaN(fallbackDate.getTime())) {
                return fallbackDate.toISOString().split("T")[0]; // Extracts YYYY-MM-DD
            }
        }

        return dateStr.split(" ")[0]; // Final fallback: Takes first part assuming "YYYY-MM-DD HH:MM:SS"
    }

    function filterTable() {
        var selectedDate = ($('#filter-date-select-date').val() || "").trim().toLowerCase();
        var selectedStudytime = ($('#filter-studytime-select-studytime').val() || "").trim().toLowerCase();
        var selectedReceived = extractDate($('#filter-Received-select-Received').val()); // Ensure only date is selected
        var selectedInstitution_name = ($('#filter-institution_name-select-institution_name').val() || "").trim().toLowerCase();
        var selectedModality = ($('#filter-Modality-select-Modality').val() || "").trim().toLowerCase();
        var selectedStudydescription = ($('#filter-Studydescription-select-Studydescription').val() || "").trim().toLowerCase();
        var selectedBodypart = ($('#filter-bodypart-select-bodypart').val() || "").trim().toLowerCase();
        var selectedAllocate = ($('#filter-allocate-select-allocate').val() || "").trim().toLowerCase();
        var selectedCorporatecoordinator = ($('#filter-coordinator-select-coordinator').val() || "").trim().toLowerCase();
        var selectedStatus = ($('#filter-status-select').val() || "").trim().toLowerCase();

        var visibleRowCount = 0;

        $('#patientTable tbody tr').each(function () {
            var rowDate = ($(this).find('td:nth-child(6)').text() || "").trim().toLowerCase();
            var rowStudytime = ($(this).find('td:nth-child(7)').text() || "").trim().toLowerCase();
            var rowReceivedText = ($(this).find('td:nth-child(8)').text() || "").trim(); // Get raw text
            var rowReceivedFormatted = extractDate(rowReceivedText); // Convert to YYYY-MM-DD
            var rowInstitution_name = ($(this).find('td:nth-child(9)').text() || "").trim().toLowerCase();
            var rowModality = ($(this).find('td:nth-child(10)').text() || "").trim().toLowerCase();
            var rowStudydescription = ($(this).find('td:nth-child(11)').text() || "").trim().toLowerCase();
            var rowBodypart = ($(this).find('td:nth-child(12)').text() || "").trim().toLowerCase();
            var rowCorporatecoordinator = ($(this).find('td:nth-child(13)').text() || "").trim().toLowerCase();
            var rowAllocate = $(this).find('td:nth-child(14)').data('radiologist') || "";
            rowAllocate = rowAllocate.trim().toLowerCase();
            var rowStatus = ($(this).find('td:nth-child(23)').text() || "").trim().toLowerCase();

            if ((selectedDate === '' || rowDate === selectedDate) 
                && (selectedCorporatecoordinator === "" || rowCorporatecoordinator === selectedCorporatecoordinator) 
                && (selectedStudytime === '' || rowStudytime === selectedStudytime) 
                && (selectedReceived === '' || rowReceivedFormatted === selectedReceived)  // Comparing formatted date
                && (selectedInstitution_name === '' || rowInstitution_name === selectedInstitution_name) 
                && (selectedModality === '' || rowModality === selectedModality) 
                && (selectedStudydescription === '' || rowStudydescription === selectedStudydescription)
                && (selectedBodypart === '' || rowBodypart === selectedBodypart)
                // && (selectedAllocate === "" || rowAllocate === selectedAllocate)
                && (selectedAllocate === "unassigned" ? rowAllocate === "" : 
                 (selectedAllocate === "" ? true : rowAllocate === selectedAllocate))
                && (selectedStatus === "" || rowStatus === selectedStatus)) { 
                $(this).show();
                visibleRowCount++;
            } else {
                $(this).hide();
            }
        });

        $('#filteredRowCount').text(visibleRowCount);
    }

    filterTable();
});
// 28-05-2025 Update by Rohan Jangid
</script>
<!--THE ABOVE CODE BY ROHAN JANGID -->

  <script>
    // Function to filter the table by status
    function applyFilter() {
    var selectedStatus = document.getElementById("filter-status-select").value;
    console.log("Selected Status:", selectedStatus);

    // Update URL without refreshing the page
    var newUrl = window.location.pathname + (selectedStatus ? "?isdone=" + selectedStatus : "");
    window.history.pushState({ path: newUrl }, "", newUrl);

    filterTable();
}

  $(document).ready(function () {
    var urlParams = new URLSearchParams(window.location.search);
    var statusFromUrl = urlParams.get("isdone");
    if (statusFromUrl) {
        $("#filter-status-select").val(statusFromUrl);
    }

    filterTable();
});

    $(document).on("change", "#filter-status-select", function () {
filterTable();   

});
    
  

        function refreshPage() {

            // Reload the page
            location.reload();

            // Show the popup message
            var popup = document.getElementById("popup-message");
            popup.style.display = "block";

            // Hide the popup after a certain time (e.g., 3 seconds)
            setTimeout(function() {
                popup.style.display = "none";
            }, 3000); // 3000 milliseconds = 3 seconds

        }

        //setInterval(refreshPage, 300000);


        // Function to show/hide the scroll-to-top button based on the scroll position
        function toggleScrollToTopButton() {
            var scrollToTopButton = $(".scroll-to-top");
            if ($(window).scrollTop() > 100) {
                scrollToTopButton.fadeIn();
            } else {
                scrollToTopButton.fadeOut();
            }
        }



        let alertSocket = new WebSocket("ws://" + window.location.host + "/ws/alerts/");

alertSocket.onopen = function() {
    console.log(" Alert socket connected.");  // should print now
};

alertSocket.onmessage = function(e) {
    let data = JSON.parse(e.data);
    console.log("Alert received:", data);
    if (data.type === "alert") {
        alert(" New message from " + data.sender + " in room " + data.room_id);
    }
};

    </script>





  <div class="footer">
    <p>&copy; 2019-2024 XRAi Digital. All rights reserved.</p>
  </div>
</body>

</html>